<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú–æ–π –ü—Å–∏—Ö–æ–ª–æ–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #F3F6F8;
      --text-main: #2C3E50;
      --text-secondary: #546E7A;
      --bot-msg-bg: #FFFFFF;
      --user-msg-bg: #5D9CEC;
      --user-msg-text: #FFFFFF;
      
      --card-blue-bg: linear-gradient(135deg, #89C4F4 0%, #5D9CEC 100%);
      --card-green-bg: linear-gradient(135deg, #A8E6CF 0%, #DCEDC8 100%);
      --card-gray-bg: linear-gradient(135deg, #E6E9F0 0%, #EEF1F5 100%);
      --card-white-bg: #FFFFFF;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; flex-direction: column;
    }

    /* --- –®–ê–ü–ö–ê --- */
    header {
      padding: 0 15px;
      background: #FFFFFF;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      z-index: 100;
      display: none; 
      align-items: center;
      height: 50px;
      flex-shrink: 0;
      width: 100%;
    }

    #back-btn {
      background: none; border: none; color: var(--text-main);
      cursor: pointer; padding: 5px; display: flex; align-items: center;
    }
    .header-title { font-size: 16px; font-weight: 600; margin-left: 10px; }

    /* --- –≠–ö–†–ê–ù–´ --- */
    .screen {
      flex: 1; 
      display: none; 
      flex-direction: column; 
      width: 100%; 
      height: 100%;
      overflow: hidden; 
      position: relative;
    }
    .screen.active { display: flex; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- –ú–ï–ù–Æ --- */
    #menu-screen { padding: 0; background-color: var(--bg-color); overflow-y: auto; }

    .profile-section {
      background: white; width: 100%; padding: 25px 20px;
      display: flex; align-items: center; gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .profile-placeholder-img { width: 60px; height: 60px; background-color: #E0E0E0; border-radius: 50%; flex-shrink: 0; }
    .profile-info h2 { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
    .profile-info p { font-size: 14px; color: #2ECC71; font-weight: 500; display: flex; align-items: center; gap: 5px; }

    .menu-list { padding: 0 15px 20px 15px; display: flex; flex-direction: column; gap: 15px; }
    .menu-card {
      border-radius: 20px; padding: 24px 20px; display: flex; align-items: center; gap: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; min-height: 100px;
    }
    .menu-card:active { transform: scale(0.98); transition: transform 0.1s; }
    .menu-content h3 { font-size: 17px; font-weight: 700; margin-bottom: 4px; color: #333333; }
    .menu-content p { font-size: 13px; font-weight: 400; color: #555555; }
    .menu-card .icon-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.4); flex-shrink: 0; }
    .menu-card .icon-circle span { font-size: 26px; }

    .card-chat { background: var(--card-blue-bg); } .card-chat .icon-circle span { color: #FFFFFF; } .card-chat h3, .card-chat p { color: white !important; }
    .card-video { background: var(--card-green-bg); } .card-video .icon-circle span { color: #27AE60; }
    .card-game { background: var(--card-gray-bg); } .card-game .icon-circle { background: #FFFFFF; } .card-game .icon-circle span { color: #5D9CEC; }
    .card-music { background: #FFFFFF; border: 1px solid #EAEAEA; } .card-music .icon-circle { background: #F5F7FA; } .card-music .icon-circle span { color: #E74C3C; }

    /* --- –ß–ê–¢ --- */
    #chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #F0F2F5; }
    .message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; }
    .msg-bot { align-self: flex-start; background-color: var(--bot-msg-bg); color: #000; border-top-left-radius: 2px; }
    .msg-user { align-self: flex-end; background-color: var(--user-msg-bg); color: var(--user-msg-text); border-top-right-radius: 2px; }
    .typing-indicator { display: none; align-self: flex-start; background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; }
    .dot { height: 6px; width: 6px; background-color: #bbb; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
    .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .input-area { background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; margin-bottom: env(safe-area-inset-bottom); }
    input[type="text"] { flex: 1; padding: 12px 15px; border-radius: 20px; border: 1px solid #E0E0E0; font-size: 16px; outline: none; background: #F9FAFB; transition: border 0.2s; }
    input[type="text"]:focus { border-color: #5D9CEC; background: white; }
    .btn-circle { width: 44px; height: 44px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s, background-color 0.2s; flex-shrink: 0; }
    .btn-circle:active { transform: scale(0.95); }
    #sendBtn { background-color: var(--user-msg-bg); color: white; box-shadow: 0 2px 5px rgba(93, 156, 236, 0.3); }
    #micBtn { background-color: #F0F2F5; color: #5D9CEC; }
    #micBtn.recording { background-color: #EF5350; color: white; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 83, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0); } }

    /* --- –ö–û–ù–¢–ï–ù–¢ --- */
    .content-list { padding: 20px; overflow-y: auto; flex: 1; background: #F9FAFB; }
    .media-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .media-icon { width: 45px; height: 45px; background: #F0F2F5; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #5D9CEC; }
    .media-info h3 { font-size: 15px; margin-bottom: 3px; color: #333; }
    .media-info p { font-size: 12px; color: #888; }
    .play-btn { margin-left: auto; color: #5D9CEC; }

   /* --- –ò–ì–†–ê (–ß–ê–°–¢–ò–¶–´ - –ù–ï–ë–û) --- */
    #game-screen {
      display: none; 
      flex-direction: column;
      align-items: center;
      justify-content: center;
      /* –ù–û–í–´–ô –¶–í–ï–¢: –°–ø–æ–∫–æ–π–Ω—ã–π –Ω–µ–±–µ—Å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
      background: radial-gradient(circle at center, #64B5F6 0%, #1976D2 100%);
      padding: 0;
      position: relative;
      overflow: hidden;
    }
    #game-screen.active { display: flex; }

    canvas#breathCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }

    .game-ui-overlay {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end; 
      height: 100%;
      width: 100%;
      padding-bottom: 80px; 
      pointer-events: none;
    }

    .breath-text-container {
      flex: 1; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px; 
    }

    .breath-status {
      font-size: 42px;
      font-weight: 800;
      color: white;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 15px;
      opacity: 1;
    }

    .breath-timer-text {
      font-size: 18px;
      color: rgba(255,255,255,0.9);
      font-weight: 500;
      letter-spacing: 1px;
    }

    .game-controls { 
      pointer-events: auto;
      display: flex; 
      gap: 20px; 
    }

    .btn-game-glass {
      padding: 18px 40px;
      border-radius: 50px;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; gap: 10px;
      /* –°—Ç–µ–∫–ª–æ –¥–ª—è —Å–≤–µ—Ç–ª–æ–≥–æ —Ñ–æ–Ω–∞ */
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      color: white;
    }

    .btn-start-glass:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
    
    .btn-stop-glass {
      background: rgba(255, 150, 150, 0.3);
      border-color: rgba(255, 100, 100, 0.3);
    }

    .btn-reset-glass {
      padding: 18px; border-radius: 50%;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }

  </style>
</head>
<body>

  <!-- –®–ê–ü–ö–ê -->
  <header id="main-header">
    <button id="back-btn" onclick="goBack()">
      <span class="material-icons-round">arrow_back</span>
      <span class="header-title" id="page-title">–ù–∞–∑–∞–¥</span>
    </button>
  </header>

  <!-- –≠–ö–†–ê–ù 1: –ú–ï–ù–Æ -->
  <div id="menu-screen" class="screen active">
    <div class="profile-section">
      <div class="profile-placeholder-img"></div>
      <div class="profile-info">
        <h2>–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞</h2>
        <p>–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ü—Å–∏—Ö–æ–ª–æ–≥ ‚Ä¢ –û–Ω–ª–∞–π–Ω</p>
      </div>
    </div>
    <div class="menu-list">
      <div class="menu-card card-chat" onclick="navigateTo('chat')">
        <div class="icon-circle"><span class="material-icons-round">chat_bubble_outline</span></div>
        <div class="menu-content"><h3>–ß–∞—Ç —Å –ü—Å–∏—Ö–æ–ª–æ–≥–æ–º</h3><p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º–∏, —è –∑–¥–µ—Å—å</p></div>
      </div>
      <div class="menu-card card-video" onclick="navigateTo('video')">
        <div class="icon-circle"><span class="material-icons-round">spa</span></div>
        <div class="menu-content"><h3>–ú–µ–¥–∏—Ç–∞—Ü–∏–∏</h3><p>–ê—É–¥–∏–æ –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏</p></div>
      </div>
      <div class="menu-card card-game" onclick="navigateTo('game')">
        <div class="icon-circle"><span class="material-icons-round">air</span></div>
        <div class="menu-content"><h3>–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ü—Ä–∞–∫—Ç–∏–∫–∏</h3><p>–¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ç—Ä–µ–≤–æ–≥–∏</p></div>
      </div>
      <div class="menu-card card-music" onclick="navigateTo('music')">
        <div class="icon-circle"><span class="material-icons-round">favorite_border</span></div>
        <div class="menu-content"><h3>–î–Ω–µ–≤–Ω–∏–∫ –≠–º–æ—Ü–∏–π</h3><p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</p></div>
      </div>
    </div>
  </div>

  <!-- –≠–ö–†–ê–ù 2: –ß–ê–¢ -->
  <div id="chat-screen" class="screen">
    <div id="chat-container">
      <div class="message msg-bot">–ü—Ä–∏–≤–µ—Ç! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å? üåø</div>
      <div class="typing-indicator" id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
    <div class="input-area">
      <button id="micBtn" class="btn-circle"><span class="material-icons-round">mic</span></button>
      <input type="text" id="userInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
      <button id="sendBtn" class="btn-circle"><span class="material-icons-round">send</span></button>
    </div>
  </div>

  <!-- –≠–ö–†–ê–ù 3: –í–ò–î–ï–û -->
  <div id="video-screen" class="screen">
    <div class="content-list">
      <div class="media-item">
        <div class="media-icon"><span class="material-icons-round">spa</span></div>
        <div class="media-info"><h3>–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞</h3><p>5 –º–∏–Ω—É—Ç —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è</p></div>
        <span class="material-icons-round play-btn">play_arrow</span>
      </div>
      <div class="media-item">
        <div class="media-icon"><span class="material-icons-round">waves</span></div>
        <div class="media-info"><h3>–®—É–º –º–æ—Ä—è</h3><p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–Ω–∞</p></div>
        <span class="material-icons-round play-btn">play_arrow</span>
      </div>
    </div>
  </div>

  <!-- –≠–ö–†–ê–ù 4: –ò–ì–†–ê (PARTICLES / –ß–ê–°–¢–ò–¶–´) -->
  <div id="game-screen" class="screen">
    <canvas id="breathCanvas"></canvas>
    
    <div class="game-ui-overlay">
      <!-- –¢–µ–∫—Å—Ç –ø–æ–¥–Ω—è—Ç –≤—ã—à–µ, –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
      <div class="breath-text-container">
        <div class="breath-status" id="breathLabel">RELAX</div>
        <div class="breath-timer-text" id="breathInstruction">–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç</div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–∂–∞—Ç—ã –∫ –Ω–∏–∑—É -->
      <div class="game-controls">
        <button class="btn-game-glass btn-start-glass" id="breathStartBtn" onclick="toggleBreathing()">
          <span class="material-icons-round" id="playIcon">play_arrow</span>
          <span id="playText">–°—Ç–∞—Ä—Ç</span>
        </button>
        
        <button class="btn-game-glass btn-reset-glass" onclick="resetBreathing()">
          <span class="material-icons-round">refresh</span>
        </button>
      </div>
    </div>
  </div>

  <!-- –≠–ö–†–ê–ù 5: –ú–£–ó–´–ö–ê -->
  <div id="music-screen" class="screen">
    <div class="content-list">
      <div class="media-item">
        <div class="media-icon"><span class="material-icons-round">music_note</span></div>
        <div class="media-info"><h3>Lo-Fi Relax</h3><p>–î–ª—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏</p></div>
        <span class="material-icons-round play-btn">play_arrow</span>
      </div>
    </div>
  </div>

  <script>
    // –í–ù–ò–ú–ê–ù–ò–ï: –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô DEPLOY
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOq4mO0Dgx9PH9AzH8ozKOYcQ0CshNHldt51VyynuR1uJZ8ZW_x71KNhG-4QV6nPF8/exec";

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.onClick(goBack);

    // --- UI –≠–õ–ï–ú–ï–ù–¢–´ ---
    const screens = {
      menu: document.getElementById('menu-screen'),
      chat: document.getElementById('chat-screen'),
      video: document.getElementById('video-screen'),
      music: document.getElementById('music-screen'),
      game: document.getElementById('game-screen')
    };

    const header = document.getElementById('main-header');
    const pageTitle = document.getElementById('page-title');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä—ã
    const breathLabel = document.getElementById('breathLabel');
    const breathInstruction = document.getElementById('breathInstruction');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const breathStartBtn = document.getElementById('breathStartBtn');
    
    // Canvas
    const canvas = document.getElementById('breathCanvas');
    const ctx = canvas.getContext('2d');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∞—Ç–∞
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typing');
    const userId = tg.initDataUnsafe?.user?.id || 'test_user_' + Math.floor(Math.random() * 1000);

    loadChatHistory();

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function navigateTo(screenName) {
      Object.values(screens).forEach(el => el.classList.remove('active'));
      screens[screenName].classList.add('active');

      if (screenName === 'menu') {
        header.style.display = 'none'; tg.BackButton.hide();
        stopBreathingAnimationLoop();
      } else {
        header.style.display = 'flex'; tg.BackButton.show();
        
        if (screenName === 'chat') { pageTitle.innerText = '–ß–∞—Ç'; setTimeout(scrollToBottom, 100); }
        else if (screenName === 'video') pageTitle.innerText = '–ú–µ–¥–∏—Ç–∞—Ü–∏–∏';
        else if (screenName === 'music') pageTitle.innerText = '–î–Ω–µ–≤–Ω–∏–∫';
        else if (screenName === 'game') {
           pageTitle.innerText = '–î—ã—Ö–∞–Ω–∏–µ';
           resizeCanvas();
           startBreathingAnimationLoop();
        }
      }
    }

    function goBack() {
      if(screens.game.classList.contains('active')) { resetBreathing(); }
      navigateTo('menu');
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (CANVAS PARTICLES) ---
    let animationId;
    let particles = [];
    
    // –†–ê–î–ò–£–°–´
    let baseRadius = 110; 
    let targetRadius = 110;
    let currentRadius = 110;
    
    let breathPhase = 'ready'; 
    let breathInterval = null;
    let breathTimer = 0;
    let isBreathing = false;
    
    // –¢–∞–π–º–∏–Ω–≥–∏
    const INHALE_TIME = 4;
    const HOLD_TIME = 7;
    const EXHALE_TIME = 8;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initParticles();
    }
    window.addEventListener('resize', resizeCanvas);

    class Particle {
      constructor() {
        this.angle = Math.random() * Math.PI * 2;
        this.distance = baseRadius + Math.random() * 20;
        this.size = Math.random() * 3 + 1;
        this.speed = Math.random() * 0.02 + 0.005;
        // –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–µ —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è —Å–∏–Ω–µ–≥–æ —Ñ–æ–Ω–∞
        this.color = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`;
        this.wobble = Math.random() * 20;
      }
      
      update(radius, phase) {
        this.angle += this.speed;
        let targetDist = radius + Math.sin(Date.now() / 500 + this.wobble) * 10;
        
        if (phase === 'inhale') {
           targetDist += Math.random() * 10;
           // –Ø—Ä–∫–æ-–±–µ–ª—ã–π/–≥–æ–ª—É–±–æ–π –ø—Ä–∏ –≤–¥–æ—Ö–µ
           this.color = `rgba(255, 255, 255, ${Math.random() * 0.7 + 0.3})`;
        } else if (phase === 'hold') {
           targetDist += Math.random() * 2;
           // –ú—è—Ç–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–µ
           this.color = `rgba(200, 255, 240, ${Math.random() * 0.6 + 0.4})`;
        } else if (phase === 'exhale') {
           // –ú—è–≥–∫–∏–π –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π –Ω–∞ –≤—ã–¥–æ—Ö–µ
           this.color = `rgba(255, 255, 255, ${Math.random() * 0.4 + 0.1})`;
        } else {
           this.color = `rgba(255, 255, 255, 0.4)`;
        }

        this.distance += (targetDist - this.distance) * 0.05;

        const cx = canvas.width / 2;
        // –ü–û–î–ù–Ø–õ–ò –¶–ï–ù–¢–† –ß–ê–°–¢–ò–¶ –í–´–®–ï, –ß–¢–û–ë–´ –ù–ï –ù–ê–ï–ó–ñ–ê–¢–¨ –ù–ê –ö–ù–û–ü–ö–ò
        const cy = (canvas.height / 2) - 60; 
        
        this.x = cx + Math.cos(this.angle) * this.distance;
        this.y = cy + Math.sin(this.angle) * this.distance;
      }
      
      draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      for (let i = 0; i < 400; i++) {
        particles.push(new Particle());
      }
    }

    function startBreathingAnimationLoop() {
      if (!animationId) animate();
    }
    
    function stopBreathingAnimationLoop() {
      cancelAnimationFrame(animationId);
      animationId = null;
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      currentRadius += (targetRadius - currentRadius) * 0.02;
      particles.forEach(p => {
        p.update(currentRadius, breathPhase);
        p.draw();
      });
      animationId = requestAnimationFrame(animate);
    }

    function toggleBreathing() {
      if (isBreathing) stopBreathing();
      else startBreathing();
    }

    function startBreathing() {
      isBreathing = true;
      playIcon.innerText = 'pause';
      playText.innerText = '–ü–∞—É–∑–∞';
      breathStartBtn.classList.add('btn-stop-glass');
      breathStartBtn.classList.remove('btn-start-glass');
      
      breathInterval = setInterval(() => {
        breathTimer++;
        updateGameLogic();
      }, 1000);
      updateGameLogic();
    }

    function stopBreathing() {
      isBreathing = false;
      clearInterval(breathInterval);
      breathInterval = null;
      playIcon.innerText = 'play_arrow';
      playText.innerText = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
      breathStartBtn.classList.remove('btn-stop-glass');
      breathStartBtn.classList.add('btn-start-glass');
    }

    function resetBreathing() {
      stopBreathing();
      breathTimer = 0;
      breathPhase = 'ready';
      targetRadius = 110; 
      
      playText.innerText = '–°—Ç–∞—Ä—Ç';
      playIcon.innerText = 'play_arrow';
      
      breathLabel.innerText = 'RELAX';
      breathInstruction.innerText = '–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç';
    }

    function updateGameLogic() {
      const cycleTime = breathTimer % (INHALE_TIME + HOLD_TIME + EXHALE_TIME);

      if (cycleTime < INHALE_TIME) {
        breathPhase = 'inhale';
        targetRadius = 180; 
        breathLabel.innerText = '–í–î–û–•';
        breathInstruction.innerText = '–ì–ª—É–±–æ–∫–∏–π –≤–¥–æ—Ö...';
      } 
      else if (cycleTime < INHALE_TIME + HOLD_TIME) {
        breathPhase = 'hold';
        targetRadius = 190;
        breathLabel.innerText = '–ü–ê–£–ó–ê';
        breathInstruction.innerText = '–ó–∞–¥–µ—Ä–∂–∏ –¥—ã—Ö–∞–Ω–∏–µ...';
      } 
      else {
        breathPhase = 'exhale';
        targetRadius = 110; 
        breathLabel.innerText = '–í–´–î–û–•';
        breathInstruction.innerText = '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–¥–æ—Ö...';
      }
    }

    // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê –ò –ê–£–î–ò–û ---
    function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
    function addMessage(text, isUser = false) {
      const msgDiv = document.createElement('div'); msgDiv.classList.add('message');
      msgDiv.classList.add(isUser ? 'msg-user' : 'msg-bot'); msgDiv.innerHTML = text.replace(/\n/g, '<br>');
      chatContainer.insertBefore(msgDiv, typingIndicator); scrollToBottom();
    }
    function showTyping(show) { typingIndicator.style.display = show ? 'block' : 'none'; scrollToBottom(); }

    function loadChatHistory() {
      showTyping(true);
      fetch(GOOGLE_SCRIPT_URL + '?act=api', {
        method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
        body: JSON.stringify({ userId: userId, action: 'load_history' }) 
      }).then(r => r.json()).then(d => {
        showTyping(false);
        if (d.status === 'success' && d.history) {
          d.history.forEach(i => {
             const m = document.createElement('div'); m.classList.add('message');
             m.classList.add(i.role === 'user' ? 'msg-user' : 'msg-bot');
             m.innerHTML = i.parts[0].text.replace(/\n/g, '<br>');
             chatContainer.insertBefore(m, typingIndicator);
          });
          scrollToBottom();
        }
      }).catch(e => showTyping(false));
    }

    function sendMessage() {
      const text = userInput.value.trim(); if (!text) return;
      addMessage(text, true); userInput.value = ''; sendBtn.disabled = true; showTyping(true);
      fetch(GOOGLE_SCRIPT_URL + '?act=api', {
        method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
        body: JSON.stringify({ text: text, userId: userId, initData: tg.initData })
      }).then(r => r.json()).then(d => {
        showTyping(false); sendBtn.disabled = false; userInput.focus();
        if (d.status === 'success') {
          addMessage(d.text, false); if(d.audio) playAudioResponse(d.audio);
        } else addMessage("‚ö†Ô∏è " + d.text, false);
      }).catch(e => { showTyping(false); sendBtn.disabled = false; addMessage("‚ùå –û—à–∏–±–∫–∞", false); });
    }
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // --- –ì–û–õ–û–° ---
    const micBtn = document.getElementById('micBtn');
    let mediaRecorder, audioChunks = [], isRecording = false, globalStream = null, currentAudio = null;

    micBtn.addEventListener('click', async () => { if (!isRecording) startRecording(); else stopRecording(); });

    async function startRecording() {
      stopCurrentAudio();
      try {
        if (!globalStream || !globalStream.active) globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(globalStream); audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendVoiceMessage;
        mediaRecorder.start(); isRecording = true;
        micBtn.classList.add('recording'); micBtn.innerHTML = '<span class="material-icons-round">stop</span>';
        if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        userInput.placeholder = "–ó–∞–ø–∏—Å—å..."; userInput.disabled = true;
      } catch (e) { addMessage("‚ö†Ô∏è –ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞", false); globalStream = null; }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop(); isRecording = false;
        micBtn.classList.remove('recording'); micBtn.innerHTML = '<span class="material-icons-round">mic</span>';
        userInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ..."; userInput.disabled = false;
      }
    }

    function sendVoiceMessage() {
      const reader = new FileReader(); showTyping(true);
      reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
      reader.onloadend = () => {
        addMessage("üé§ <i>–ê—É–¥–∏–æ...</i>", true);
        fetch(GOOGLE_SCRIPT_URL + '?act=api', {
          method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
          body: JSON.stringify({ userId: userId, audio: reader.result, initData: tg.initData })
        }).then(r => r.json()).then(d => {
          showTyping(false);
          if (d.status === 'success') {
             if(d.recognizedText) addMessage("üó£ " + d.recognizedText, true);
             addMessage(d.text, false); if(d.audio) playAudioResponse(d.audio);
          } else addMessage("‚ö†Ô∏è " + d.text, false);
        }).catch(e => { showTyping(false); addMessage("‚ùå –û—à–∏–±–∫–∞", false); });
      };
    }

    function stopCurrentAudio() { if (currentAudio) { currentAudio.pause(); currentAudio = null; } }
    function playAudioResponse(base64) {
       stopCurrentAudio(); currentAudio = new Audio("data:audio/mp3;base64," + base64);
       currentAudio.play().catch(e => console.log(e));
       currentAudio.onended = () => { currentAudio = null; };
    }
  </script>
</body>
</html>
