<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mental Health AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            /* --- –ü–ê–õ–ò–¢–†–ê FRESH MINT (No Purple) --- */
            
            /* –§–û–ù */
            --bg-main: #F5F7FA;      
            --bg-card: #FFFFFF;      
            
            /* –¢–ò–ü–û–ì–†–ê–§–ò–Ø */
            --text-header: #1F2937;  
            --text-body: #4B5563;    
            --text-muted: #9CA3AF;   
            
            /* –ì–õ–ê–í–ù–´–ô –ê–ö–¶–ï–ù–¢ (–ú—è—Ç–∞/Teal) */
            --primary-main: #4DB6AC; /* –û—Å–Ω–æ–≤–Ω–æ–π –º—è—Ç–Ω—ã–π */
            --primary-soft: #E0F2F1; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –º—è—Ç–Ω—ã–π */
            --primary-text: #00695C; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –º—è—Ç–Ω–æ–º */
            
            /* –í–¢–û–†–ò–ß–ù–´–ï (–ì–æ–ª—É–±–æ–π - –í–æ–∑–¥—É—Ö) */
            --secondary-bg: #E3F2FD; 
            --secondary-accent: #64B5F6;
            
            /* –¢–ï–ü–õ–´–ô (–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π - –ó–∞–±–æ—Ç–∞) */
            --warm-bg: #FFF3E0;
            --warm-accent: #FFB74D;

            /* –ö–ê–†–¢–û–ß–ö–ò –ò –¢–ï–ù–ò */
            --radius-card: 24px;
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.04);
            
            /* –ò–ö–û–ù–ö–ò */
            --icon-default: #78909C; /* –°–µ—Ä–æ-–≥–æ–ª—É–±–æ–π */
            
            /* –ß–ê–¢ */
            --msg-bot-bg: #FFFFFF;
            --msg-user-bg: #4DB6AC; /* –°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –º—è—Ç–Ω—ã–µ */
            --msg-user-text: #FFFFFF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-body);
            line-height: 1.5;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }

        h1, h2, h3, h4 {
            color: var(--text-header);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* --- –®–ê–ü–ö–ê --- */
        header {
            padding: 0 20px;
            background: transparent;
            z-index: 100;
            display: none;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
            width: 100%;
        }

        #back-btn {
            background: var(--bg-card); border: none; color: var(--text-header);
            width: 44px; height: 44px; border-radius: 16px;
            box-shadow: var(--shadow-card);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .header-title { font-size: 18px; font-weight: 600; margin-left: 15px; color: var(--text-header); }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen {
            flex: 1; display: none; flex-direction: column; width: 100%; height: 100%; overflow: hidden; position: relative;
        }
        .screen.active { display: flex; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
           ========================================= */
        #menu-screen { padding: 24px; overflow-y: auto; }

        /* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ */
        .greeting-header {
            margin-top: 10px; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .greeting-text h1 { font-size: 26px; line-height: 1.3; }
        .greeting-text p { font-size: 16px; color: var(--text-muted); margin-top: 4px; }
        
        .avatar-circle {
            width: 52px; height: 52px;
            background: var(--primary-soft);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary-main); /* –ú—è—Ç–Ω–∞—è –∏–∫–æ–Ω–∫–∞ */
        }

        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 16px; color: var(--text-header); }

        /* –°–µ—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
        .main-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;
        }

        .action-card {
            border-radius: var(--radius-card);
            padding: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            height: 150px;
            cursor: pointer; transition: transform 0.1s;
            background-color: var(--primary-soft); /* –ú—è—Ç–Ω—ã–π —Ñ–æ–Ω */
        }
        .action-card:active { transform: scale(0.97); }

        /* –ß–ê–¢ - –ú–Ø–¢–ù–´–ô */
        .card-chat h3 { color: var(--primary-text); }
        .card-chat .icon-box { color: var(--primary-main); border: 1px solid rgba(77, 182, 172, 0.2); }

        /* –î–´–•–ê–ù–ò–ï - –ì–û–õ–£–ë–û–ô */
        .card-breath { background-color: var(--secondary-bg); }
        .card-breath h3 { color: #1565C0; }
        .card-breath .icon-box { color: var(--secondary-accent); border: 1px solid rgba(100, 181, 246, 0.2); }

        .icon-box {
            width: 50px; height: 50px; border-radius: 16px;
            background: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px;
        }
        .icon-box span { font-size: 26px; }
        .action-card h3 { font-size: 15px; font-weight: 600; }

        /* –í–∏–¥–∂–µ—Ç "–í–æ–ª–Ω–∞" */
        .widget-card {
            background: #E0F2F1; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –º—è—Ç–Ω—ã–π —Ñ–æ–Ω */
            border-radius: var(--radius-card); padding: 20px;
            margin-bottom: 24px; position: relative; overflow: hidden; cursor: pointer;
        }
        .widget-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .dot-indicator { width: 8px; height: 8px; background: var(--primary-main); border-radius: 50%; opacity: 0.8; }
        .widget-title { font-size: 14px; color: var(--text-muted); }
        .widget-main-text { font-size: 18px; font-weight: 600; color: var(--text-header); }
        
        .wave-graph { width: 100%; height: 50px; margin-top: 8px; opacity: 0.9; }

        /* –ù–∏–∂–Ω–∏–π —Ä—è–¥ */
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .small-card {
            background: var(--bg-card); padding: 16px; border-radius: 20px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow-card); cursor: pointer;
        }
        .small-icon { 
            width: 36px; height: 36px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
        }
        /* –î–Ω–µ–≤–Ω–∏–∫ - –ü–µ—Ä—Å–∏–∫–æ–≤—ã–π */
        .warm-icon { background: var(--warm-bg); color: var(--warm-accent); }
        /* –ü–ª–∞–Ω—ã - –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π */
        .grey-icon { background: #ECEFF1; color: var(--icon-default); }
        
        .small-card h4 { font-size: 14px; font-weight: 600; color: var(--text-header); }
        .small-card span { font-size: 11px; color: var(--text-muted); }


        /* =========================================
           –ß–ê–¢
           ========================================= */
        #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        
        .message { 
            max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 15px; 
            box-shadow: var(--shadow-card);
        }
        .msg-bot { 
            align-self: flex-start; background-color: var(--msg-bot-bg); color: var(--text-body); 
            border-top-left-radius: 4px; 
        }
        .msg-user { 
            align-self: flex-end; background-color: var(--msg-user-bg); color: var(--msg-user-text); 
            border-top-right-radius: 4px; 
            /* –ú—è—Ç–Ω–∞—è —Ç–µ–Ω—å */
            box-shadow: 0 4px 12px rgba(77, 182, 172, 0.3); 
        }
        
        .typing-indicator { display: none; align-self: flex-start; background: var(--bg-card); padding: 12px; border-radius: 16px; margin-bottom: 10px; box-shadow: var(--shadow-card); }
        .dot { height: 6px; width: 6px; background-color: #CFD8DC; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .input-area { 
            background: var(--bg-main); padding: 12px 20px; 
            display: flex; align-items: center; gap: 12px; 
            padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
        }
        input[type="text"] { 
            flex: 1; padding: 14px 20px; border-radius: 24px; border: none; 
            font-size: 16px; outline: none; background: var(--bg-card); 
            box-shadow: var(--shadow-card); color: var(--text-header);
        }
        .btn-circle { 
            width: 46px; height: 46px; border-radius: 50%; border: none; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: transform 0.1s; flex-shrink: 0; 
            box-shadow: var(--shadow-card);
        }
        .btn-circle:active { transform: scale(0.95); }
        
        #sendBtn { background-color: var(--primary-main); color: white; }
        
        #micBtn { background-color: var(--bg-card); color: var(--icon-default); }
        /* –ê–∫—Ç–∏–≤–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω: –ü—É–ª—å—Å–∞—Ü–∏—è –º—è—Ç–Ω—ã–º */
        #micBtn.recording { 
            background-color: var(--primary-soft); 
            color: var(--primary-main); 
            animation: pulse-mint 2s infinite; 
            border: 1px solid var(--primary-main);
        }
        @keyframes pulse-mint { 
            0% { box-shadow: 0 0 0 0 rgba(77, 182, 172, 0.4); } 
            70% { box-shadow: 0 0 0 8px rgba(77, 182, 172, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(77, 182, 172, 0); } 
        }

        /* –°–ü–ò–°–ö–ò */
        .content-list { padding: 24px; overflow-y: auto; flex: 1; }
        .media-item { 
            background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); margin-bottom: 16px; 
            display: flex; align-items: center; gap: 16px; 
            box-shadow: var(--shadow-card); cursor: pointer; 
        }
        .media-icon { 
            width: 44px; height: 44px; background: #ECEFF1; border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; color: var(--icon-default); 
        }
        .media-info h3 { font-size: 16px; margin-bottom: 4px; color: var(--text-header); }
        .media-info p { font-size: 13px; color: var(--text-muted); }
        .play-btn { margin-left: auto; color: var(--primary-main); }

        /* –ò–ì–†–ê (–î–´–•–ê–ù–ò–ï) */
        #game-screen {
            background: #E0F2F1; /* –ú—è—Ç–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –¥—ã—Ö–∞–Ω–∏—è */
        }
        #game-screen .breath-status { color: var(--text-header); text-shadow: none; font-weight: 600; }
        #game-screen .breath-timer-text { color: var(--text-body); }
        
        .btn-game-soft {
            padding: 18px 40px; border-radius: 50px; border: none;
            font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;
            background: var(--bg-card); color: var(--primary-main);
            box-shadow: var(--shadow-card);
        }
        .btn-reset-soft {
            padding: 18px; border-radius: 50%; background: var(--bg-card); color: var(--text-body); border: none;
            box-shadow: var(--shadow-card);
        }

        canvas#breathCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.5; }
        .game-ui-overlay { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; width: 100%; padding-bottom: 60px; pointer-events: none; }
        .breath-text-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; }
        .game-controls { pointer-events: auto; display: flex; gap: 20px; }

    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê -->
    <header id="main-header">
        <button id="back-btn" onclick="goBack()">
            <span class="material-icons-round">arrow_back</span>
        </button>
        <span class="header-title" id="page-title">–ù–∞–∑–∞–¥</span>
    </header>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="menu-screen" class="screen active">
        
        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
        <div class="greeting-header">
            <div class="greeting-text">
                <h1>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,<br>User</h1>
                <p>–ß—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç –≤–∞—Å —Å–µ–≥–æ–¥–Ω—è?</p>
            </div>
            <div class="avatar-circle">
                <span class="material-icons-round">person</span>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="main-grid">
            <!-- –ß–∞—Ç: –ú—è—Ç–Ω—ã–π -->
            <div class="action-card card-chat" onclick="navigateTo('chat', '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å')">
                <div class="icon-box">
                    <span class="material-icons-round">chat_bubble_outline</span>
                </div>
                <h3>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h3>
            </div>
            
            <!-- –î—ã—Ö–∞–Ω–∏–µ: –ì–æ–ª—É–±–æ–π -->
            <div class="action-card card-breath" onclick="navigateTo('game')">
                <div class="icon-box">
                    <span class="material-icons-round">air</span>
                </div>
                <h3>–î—ã—Ö–∞–Ω–∏–µ</h3>
            </div>
        </div>

        <!-- –í–∏–¥–∂–µ—Ç "–í–æ–ª–Ω–∞" (–ú—è—Ç–Ω–∞—è) -->
        <div class="section-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
        <div class="widget-card" onclick="navigateTo('video')">
            <div class="widget-header">
                <div class="dot-indicator"></div>
                <div class="widget-title">–ú–µ–¥–∏—Ç–∞—Ü–∏–∏</div>
            </div>
            <div class="widget-main-text">–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</div>
            <!-- SVG –í–æ–ª–Ω–∞ (–ú—è—Ç–Ω–∞—è) -->
            <svg class="wave-graph" viewBox="0 0 300 50" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#4DB6AC;stop-opacity:0.6" />
                        <stop offset="100%" style="stop-color:#4DB6AC;stop-opacity:0" />
                    </linearGradient>
                </defs>
                <path d="M0,25 Q75,5 150,25 T300,25 V50 H0 Z" fill="url(#grad1)" />
                <path d="M0,25 Q75,5 150,25 T300,25" stroke="#4DB6AC" stroke-width="2" fill="none"/>
            </svg>
        </div>

        <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ -->
        <div class="bottom-grid">
            <div class="small-card" onclick="navigateTo('music')">
                <div class="small-icon warm-icon">
                    <span class="material-icons-round">favorite_border</span>
                </div>
                <div>
                    <h4>–î–Ω–µ–≤–Ω–∏–∫</h4>
                    <span>–ó–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ</span>
                </div>
            </div>
            <div class="small-card">
                <div class="small-icon grey-icon">
                    <span class="material-icons-round">lightbulb</span>
                </div>
                <div>
                    <h4>–ü–ª–∞–Ω—ã</h4>
                    <span>–†–µ—Å—É—Ä—Å—ã</span>
                </div>
            </div>
        </div>

    </div>

    <!-- –≠–ö–†–ê–ù 2: –ß–ê–¢ -->
    <div id="chat-screen" class="screen">
        <div id="chat-container">
            <div class="message msg-bot">–Ø —Ä—è–¥–æ–º. –í—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –º–Ω–µ –≤—Å–µ, —á—Ç–æ –≤–∞—Å —Ç—Ä–µ–≤–æ–∂–∏—Ç. –ú—ã —Å–ø—Ä–∞–≤–∏–º—Å—è. üåø</div>
            <div class="typing-indicator" id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
        <div class="input-area">
            <button id="micBtn" class="btn-circle"><span class="material-icons-round">mic</span></button>
            <input type="text" id="userInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="sendBtn" class="btn-circle"><span class="material-icons-round">arrow_upward</span></button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –ú–ï–î–ò–¢–ê–¶–ò–ò -->
    <div id="video-screen" class="screen">
        <div class="content-list">
            <h2 class="section-title" style="margin-top:0;">–ü—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–∫–æ—è</h2>
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">self_improvement</span></div>
                <div class="media-info"><h3>–û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ</h3><p>5 –º–∏–Ω—É—Ç</p></div>
                <span class="material-icons-round play-btn">play_arrow</span>
            </div>
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">bedtime</span></div>
                <div class="media-info"><h3>–ü–µ—Ä–µ–¥ —Å–Ω–æ–º</h3><p>10 –º–∏–Ω—É—Ç</p></div>
                <span class="material-icons-round play-btn">play_arrow</span>
            </div>
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">forest</span></div>
                <div class="media-info"><h3>–ó–≤—É–∫–∏ –ø—Ä–∏—Ä–æ–¥—ã</h3><p>–†–µ–ª–∞–∫—Å</p></div>
                <span class="material-icons-round play-btn">play_arrow</span>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –ò–ì–†–ê -->
    <div id="game-screen" class="screen">
        <canvas id="breathCanvas"></canvas>
        <div class="game-ui-overlay">
            <div class="breath-text-container">
                <div class="breath-status" id="breathLabel">–î–´–®–ò–ú</div>
                <div class="breath-timer-text" id="breathInstruction">–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç</div>
            </div>
            <div class="game-controls">
                <button class="btn-game-soft" id="breathStartBtn" onclick="toggleBreathing()">
                    <span class="material-icons-round" id="playIcon">play_arrow</span>
                    <span id="playText">–°—Ç–∞—Ä—Ç</span>
                </button>
                <button class="btn-reset-soft" onclick="resetBreathing()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 5: –î–ù–ï–í–ù–ò–ö -->
    <div id="music-screen" class="screen">
        <div class="content-list">
            <h2 class="section-title">–í–∞—à–∏ –∑–∞–ø–∏—Å–∏</h2>
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">lock</span></div>
                <div class="media-info"><h3>–õ–∏—á–Ω–æ–µ</h3><p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—Ö–æ–¥–∞</p></div>
            </div>
        </div>
    </div>

<script>
    // === –õ–û–ì–ò–ö–ê ===
    
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOq4mO0Dgx9PH9AzH8ozKOYcQ0CshNHldt51VyynuR1uJZ8ZW_x71KNhG-4QV6nPF8/exec";
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.onClick(goBack);

    const screens = {
        menu: document.getElementById('menu-screen'),
        chat: document.getElementById('chat-screen'),
        video: document.getElementById('video-screen'),
        music: document.getElementById('music-screen'),
        game: document.getElementById('game-screen')
    };

    const header = document.getElementById('main-header');
    const pageTitle = document.getElementById('page-title');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä—ã
    const breathLabel = document.getElementById('breathLabel');
    const breathInstruction = document.getElementById('breathInstruction');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const breathStartBtn = document.getElementById('breathStartBtn');
    const canvas = document.getElementById('breathCanvas');
    const ctx = canvas.getContext('2d');

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typing');
    const userId = tg.initDataUnsafe?.user?.id || 'web_user_' + Math.floor(Math.random() * 1000);
    const userName = tg.initDataUnsafe?.user?.first_name || '–î—Ä—É–≥';

    document.querySelector('.greeting-text h1').innerHTML = `–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,<br>${userName}`;

    loadChatHistory();

    function navigateTo(screenName, initialMessage = null) {
        Object.values(screens).forEach(el => el.classList.remove('active'));
        screens[screenName].classList.add('active');

        if (screenName === 'menu') {
            header.style.display = 'none'; tg.BackButton.hide();
            stopBreathingAnimationLoop();
        } else {
            header.style.display = 'flex'; tg.BackButton.show();
            if (screenName === 'chat') { 
                pageTitle.innerText = '–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏'; setTimeout(scrollToBottom, 100); 
                if (initialMessage) userInput.value = initialMessage;
            }
            else if (screenName === 'video') pageTitle.innerText = '–ú–µ–¥–∏—Ç–∞—Ü–∏–∏';
            else if (screenName === 'music') pageTitle.innerText = '–î–Ω–µ–≤–Ω–∏–∫';
            else if (screenName === 'game') {
                pageTitle.innerText = '–î—ã—Ö–∞–Ω–∏–µ'; resizeCanvas(); startBreathingAnimationLoop();
            }
        }
    }

    function goBack() {
        if(screens.game.classList.contains('active')) { resetBreathing(); }
        navigateTo('menu');
    }

    // --- GAME LOGIC (MINT PARTICLES) ---
    let animationId;
    let particles = [];
    let baseRadius = 110;
    let targetRadius = 110;
    let currentRadius = 110;
    let breathPhase = 'ready';
    let breathInterval = null;
    let breathTimer = 0;
    let isBreathing = false;
    const INHALE_TIME = 4;
    const HOLD_TIME = 7;
    const EXHALE_TIME = 8;

    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); }
    window.addEventListener('resize', resizeCanvas);

    class Particle {
        constructor() {
            this.angle = Math.random() * Math.PI * 2;
            this.distance = baseRadius + Math.random() * 20;
            this.size = Math.random() * 3 + 1;
            this.speed = Math.random() * 0.02 + 0.005;
            // –¶–≤–µ—Ç —á–∞—Å—Ç–∏—Ü: –ú–Ø–¢–ù–´–ô
            this.color = `rgba(77, 182, 172, ${Math.random() * 0.4 + 0.1})`; 
            this.wobble = Math.random() * 20;
        }
        update(radius, phase) {
            this.angle += this.speed;
            let targetDist = radius + Math.sin(Date.now() / 500 + this.wobble) * 10;
            if (phase === 'inhale') {
                targetDist += Math.random() * 10;
                this.color = `rgba(77, 182, 172, ${Math.random() * 0.6 + 0.3})`;
            } else if (phase === 'hold') {
                targetDist += Math.random() * 2;
                this.color = `rgba(38, 166, 154, ${Math.random() * 0.5 + 0.3})`; // –¢–µ–º–Ω–µ–µ –º—è—Ç–∞
            } else if (phase === 'exhale') {
                this.color = `rgba(77, 182, 172, ${Math.random() * 0.3 + 0.1})`;
            }
            this.distance += (targetDist - this.distance) * 0.05;
            const cx = canvas.width / 2; const cy = (canvas.height / 2) - 60;
            this.x = cx + Math.cos(this.angle) * this.distance;
            this.y = cy + Math.sin(this.angle) * this.distance;
        }
        draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
    }

    function initParticles() { particles = []; for (let i = 0; i < 150; i++) particles.push(new Particle()); }
    function startBreathingAnimationLoop() { if (!animationId) animate(); }
    function stopBreathingAnimationLoop() { cancelAnimationFrame(animationId); animationId = null; }
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        currentRadius += (targetRadius - currentRadius) * 0.02;
        particles.forEach(p => { p.update(currentRadius, breathPhase); p.draw(); });
        animationId = requestAnimationFrame(animate);
    }
    function toggleBreathing() { if (isBreathing) stopBreathing(); else startBreathing(); }
    function startBreathing() {
        isBreathing = true; playIcon.innerText = 'pause'; playText.innerText = '–ü–∞—É–∑–∞';
        breathInterval = setInterval(() => { breathTimer++; updateGameLogic(); }, 1000); updateGameLogic();
    }
    function stopBreathing() {
        isBreathing = false; clearInterval(breathInterval); breathInterval = null;
        playIcon.innerText = 'play_arrow'; playText.innerText = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    }
    function resetBreathing() {
        stopBreathing(); breathTimer = 0; breathPhase = 'ready'; targetRadius = 110;
        playText.innerText = '–°—Ç–∞—Ä—Ç'; playIcon.innerText = 'play_arrow';
        breathLabel.innerText = '–î–´–®–ò–ú'; breathInstruction.innerText = '–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç';
    }
    function updateGameLogic() {
        const cycleTime = breathTimer % (INHALE_TIME + HOLD_TIME + EXHALE_TIME);
        if (cycleTime < INHALE_TIME) { breathPhase = 'inhale'; targetRadius = 180; breathLabel.innerText = '–í–î–û–•'; breathInstruction.innerText = '–°–ø–æ–∫–æ–π–Ω—ã–π –≤–¥–æ—Ö...'; }
        else if (cycleTime < INHALE_TIME + HOLD_TIME) { breathPhase = 'hold'; targetRadius = 190; breathLabel.innerText = '–ü–ê–£–ó–ê'; breathInstruction.innerText = '–ó–∞–¥–µ—Ä–∂–∏—Ç–µ...'; }
        else { breathPhase = 'exhale'; targetRadius = 110; breathLabel.innerText = '–í–´–î–û–•'; breathInstruction.innerText = '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–¥–æ—Ö...'; }
    }

    // --- CHAT LOGIC ---
    function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
    function addMessage(text, isUser = false) {
        const msgDiv = document.createElement('div'); msgDiv.classList.add('message');
        msgDiv.classList.add(isUser ? 'msg-user' : 'msg-bot'); msgDiv.innerHTML = text.replace(/\n/g, '<br>');
        chatContainer.insertBefore(msgDiv, typingIndicator); scrollToBottom();
    }
    function showTyping(show) { typingIndicator.style.display = show ? 'block' : 'none'; scrollToBottom(); }
    function loadChatHistory() {
        showTyping(true);
        fetch(GOOGLE_SCRIPT_URL + '?act=api', {
            method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
            body: JSON.stringify({ userId: userId, action: 'load_history' })
        }).then(r => r.json()).then(d => {
            showTyping(false);
            if (d.status === 'success' && d.history) {
                d.history.forEach(i => {
                    const m = document.createElement('div'); m.classList.add('message');
                    m.classList.add(i.role === 'user' ? 'msg-user' : 'msg-bot');
                    m.innerHTML = i.parts[0].text.replace(/\n/g, '<br>');
                    chatContainer.insertBefore(m, typingIndicator);
                });
                scrollToBottom();
            }
        }).catch(e => showTyping(false));
    }
    function sendMessage() {
        const text = userInput.value.trim(); if (!text) return;
        addMessage(text, true); userInput.value = ''; sendBtn.disabled = true; showTyping(true);
        fetch(GOOGLE_SCRIPT_URL + '?act=api', {
            method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
            body: JSON.stringify({ text: text, userId: userId, initData: tg.initData })
        }).then(r => r.json()).then(d => {
            showTyping(false); sendBtn.disabled = false; userInput.focus();
            if (d.status === 'success') {
                addMessage(d.text, false); if(d.audio) playAudioResponse(d.audio);
            } else addMessage("‚ö†Ô∏è " + d.text, false);
        }).catch(e => { showTyping(false); sendBtn.disabled = false; addMessage("‚ùå –û—à–∏–±–∫–∞", false); });
    }
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // --- VOICE LOGIC ---
    const micBtn = document.getElementById('micBtn');
    let mediaRecorder, audioChunks = [], isRecording = false, globalStream = null, currentAudio = null;
    micBtn.addEventListener('click', async () => { if (!isRecording) startRecording(); else stopRecording(); });
    async function startRecording() {
        stopCurrentAudio();
        try {
            if (!globalStream || !globalStream.active) globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(globalStream); audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendVoiceMessage;
            mediaRecorder.start(); isRecording = true;
            micBtn.classList.add('recording'); micBtn.innerHTML = '<span class="material-icons-round">stop</span>';
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            userInput.placeholder = "–ó–∞–ø–∏—Å—å..."; userInput.disabled = true;
        } catch (e) { addMessage("‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É", false); globalStream = null; }
    }
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop(); isRecording = false;
            micBtn.classList.remove('recording'); micBtn.innerHTML = '<span class="material-icons-round">mic</span>';
            userInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ..."; userInput.disabled = false;
        }
    }
    function sendVoiceMessage() {
        const reader = new FileReader(); showTyping(true);
        reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
        reader.onloadend = () => {
            addMessage("üé§ <i>–ê—É–¥–∏–æ...</i>", true);
            fetch(GOOGLE_SCRIPT_URL + '?act=api', {
                method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
                body: JSON.stringify({ userId: userId, audio: reader.result, initData: tg.initData })
            }).then(r => r.json()).then(d => {
                showTyping(false);
                if (d.status === 'success') {
                    if(d.recognizedText) addMessage("üó£ " + d.recognizedText, true);
                    addMessage(d.text, false); if(d.audio) playAudioResponse(d.audio);
                } else addMessage("‚ö†Ô∏è " + d.text, false);
            }).catch(e => { showTyping(false); addMessage("‚ùå –û—à–∏–±–∫–∞", false); });
        };
    }
    function stopCurrentAudio() { if (currentAudio) { currentAudio.pause(); currentAudio = null; } }
    function playAudioResponse(base64) {
        stopCurrentAudio(); currentAudio = new Audio("data:audio/mp3;base64," + base64);
        currentAudio.play().catch(e => console.log(e));
        currentAudio.onended = () => { currentAudio = null; };
    }
</script>
</body>
</html>
