<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI –ü—Å–∏—Ö–æ–ª–æ–≥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            /* --- –ù–û–í–ê–Ø –¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê (–ø–æ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç) --- */
            --bg-top: #B8E1F7;      /* –ì–æ–ª—É–±–æ–π –≤–µ—Ä—Ö */
            --bg-bottom: #F9F7F2;   /* –¢–µ–ø–ª—ã–π –±–µ–ª—ã–π –Ω–∏–∑ */
            
            --text-primary: #2C4356;
            --text-secondary: #6F818D;
            
            --hero-card-bg: linear-gradient(135deg, #98D3EF 0%, #76BEDE 100%);
            --light-card-bg: #FFF9F0;
            
            /* –¶–≤–µ—Ç–∞ —á–∞—Ç–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–æ —Å –Ω–æ–≤—ã–º–∏ –æ—Ç—Ç–µ–Ω–∫–∞–º–∏) */
            --bot-msg-bg: #FFFFFF;
            --user-msg-bg: #76BEDE;
            --user-msg-text: #FFFFFF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            width: 100%; height: 100%; overflow: hidden; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* –û–±—â–∏–π —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ */
            background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 45%, var(--bg-bottom) 100%);
            color: var(--text-primary);
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }

        /* --- –®–ê–ü–ö–ê (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª–æ–≤) --- */
        header {
            padding: 0 15px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            z-index: 100;
            display: none;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
            width: 100%;
        }

        #back-btn {
            background: none; border: none; color: var(--text-primary);
            cursor: pointer; padding: 5px; display: flex; align-items: center;
        }
        .header-title { font-size: 16px; font-weight: 600; margin-left: 10px; }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           –î–ò–ó–ê–ô–ù –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ (–ú–ï–ù–Ø–ï–ú –¢–û–õ–¨–ö–û CSS/HTML)
           ========================================= */
        #menu-screen {
            padding: 20px 24px;
            overflow-y: auto;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç */
        }

        /* –õ–æ–≥–æ—Ç–∏–ø (–ì–æ–ª–æ–≤–∞) */
        .brand-container {
            margin-top: 30px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .logo-icon-wrap {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .logo-icon {
            font-size: 130px;
            /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –≥–æ–ª–æ–≤—ã */
            color: white;
            opacity: 0.8;
            filter: drop-shadow(0 10px 20px rgba(118, 190, 222, 0.4));
            background: linear-gradient(to bottom, #FFF, rgba(255,255,255,0.2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .app-desc {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.4;
            max-width: 280px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ–Ω—é */
        .menu-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 40px;
        }

        .menu-card {
            border-radius: 24px;
            padding: 22px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ –¥–ª—è —Å—Ç–∏–ª—è */
            border: 1px solid rgba(255,255,255,0.6); 
        }
        .menu-card:active { transform: scale(0.98); }

        /* HERO CARD (–°–∏–Ω—è—è) */
        .card-hero {
            background: var(--hero-card-bg);
            box-shadow: 0 10px 20px rgba(118, 190, 222, 0.4);
            border: none;
            padding: 26px 24px;
        }
        .card-hero h3 { color: white; font-size: 19px; font-weight: 700; margin-bottom: 4px; }
        .card-hero p { color: rgba(255,255,255,0.95); font-size: 14px; }
        .card-hero .icon-circle {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        /* LIGHT CARD (–ë–µ–∂–µ–≤–∞—è) */
        .card-light {
            background: var(--light-card-bg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .card-light h3 { color: var(--text-primary); font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .card-light p { color: var(--text-secondary); font-size: 13px; }

        /* –ò–∫–æ–Ω–∫–∏ –≤ –∫—Ä—É–∂–æ—á–∫–∞—Ö */
        .icon-circle {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .icon-circle span { font-size: 26px; }

        /* –¶–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫ –¥–ª—è —Å–≤–µ—Ç–ª—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .icon-meditation { background: #EFEBE5; color: #C4A48A; }
        .icon-breath { background: #E6EFEC; color: #8FBCA0; }
        .icon-journal { background: #EAEBF0; color: #9FA6B5; }

        /* --- –û–°–¢–ê–õ–¨–ù–´–ï –≠–ö–†–ê–ù–´ (–°—Ç–∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –Ω–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É) --- */

        /* –ß–ê–¢ */
        #chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #F4F6F8; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg-bot { align-self: flex-start; background-color: var(--bot-msg-bg); color: #000; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-user { align-self: flex-end; background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(118, 190, 222, 0.3); }
        
        .typing-indicator { display: none; align-self: flex-start; background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; }
        .dot { height: 6px; width: 6px; background-color: #bbb; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .input-area { background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input[type="text"] { flex: 1; padding: 12px 15px; border-radius: 20px; border: 1px solid #E0E0E0; font-size: 16px; outline: none; background: #F9FAFB; transition: border 0.2s; }
        input[type="text"]:focus { border-color: #76BEDE; background: white; }
        .btn-circle { width: 44px; height: 44px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; flex-shrink: 0; }
        .btn-circle:active { transform: scale(0.95); }
        #sendBtn { background-color: var(--user-msg-bg); color: white; box-shadow: 0 2px 5px rgba(93, 156, 236, 0.3); }
        #micBtn { background-color: #F0F2F5; color: #6F818D; }
        #micBtn.recording { background-color: #EF5350; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 83, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0); } }

        /* –°–ü–ò–°–ö–ò (–ú–ï–î–ò–¢–ê–¶–ò–ò) */
        .content-list { padding: 20px; overflow-y: auto; flex: 1; background: #F9F7F2; }
        .media-item { background: white; padding: 18px; border-radius: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; }
        .media-item:active { transform: scale(0.98); }
        .media-icon { width: 45px; height: 45px; background: #F0EBE5; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #C4A48A; }
        .media-info h3 { font-size: 15px; margin-bottom: 3px; color: #2C4356; font-weight: 600; }
        .media-info p { font-size: 12px; color: #888; }
        .play-btn { margin-left: auto; color: #76BEDE; }

        /* –ò–ì–†–ê (–î–´–•–ê–ù–ò–ï) */
        #game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #98D3EF 0%, #2980B9 100%);
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        #game-screen.active { display: flex; }

        canvas#breathCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        .game-ui-overlay {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100%;
            width: 100%;
            padding-bottom: 80px;
            pointer-events: none;
        }

        .breath-text-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .breath-status {
            font-size: 42px; font-weight: 800; color: white;
            text-transform: uppercase; letter-spacing: 4px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 15px;
        }

        .breath-timer-text { font-size: 18px; color: rgba(255,255,255,0.9); font-weight: 500; letter-spacing: 1px; }

        .game-controls { pointer-events: auto; display: flex; gap: 20px; }
        .btn-game-glass {
            padding: 18px 40px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.3);
            font-size: 18px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .btn-start-glass:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .btn-stop-glass { background: rgba(255, 150, 150, 0.3); border-color: rgba(255, 100, 100, 0.3); }
        .btn-reset-glass { padding: 18px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }

    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü) -->
    <header id="main-header">
        <button id="back-btn" onclick="goBack()">
            <span class="material-icons-round">arrow_back_ios_new</span>
            <span class="header-title" id="page-title">–ù–∞–∑–∞–¥</span>
        </button>
    </header>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) -->
    <div id="menu-screen" class="screen active">
        
        <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="brand-container">
            <div class="logo-icon-wrap">
                <span class="material-icons-round logo-icon">psychology</span>
            </div>
            <h1 class="app-h1">AI-–ø—Å–∏—Ö–æ–ª–æ–≥ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
            <p class="app-desc">–Ø —Ä—è–¥–æ–º. –ü–æ–º–æ–≥—É –ø–µ—Ä–µ–∂–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É –∏ –ø–∞–Ω–∏—á–µ—Å–∫—É—é –∞—Ç–∞–∫—É</p>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
        <div class="menu-list">
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: HERO (–°–∏–Ω—è—è) -->
            <div class="menu-card card-hero" onclick="navigateTo('chat', '–ú–Ω–µ —Å–µ–π—á–∞—Å —Ç—Ä–µ–≤–æ–∂–Ω–æ')">
                <div class="icon-circle">
                    <span class="material-icons-round">air</span>
                </div>
                <div class="menu-content">
                    <h3>–ú–Ω–µ —Å–µ–π—á–∞—Å —Ç—Ä–µ–≤–æ–∂–Ω–æ</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ —Ç—è–∂–µ–ª–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: LIGHT (–ú–µ–¥–∏—Ç–∞—Ü–∏–∏) -->
            <div class="menu-card card-light" onclick="navigateTo('video')">
                <div class="icon-circle icon-meditation">
                    <span class="material-icons-round">spa</span>
                </div>
                <div class="menu-content">
                    <h3>–ú—è–≥–∫–∏–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏</h3>
                    <p>–î–ª—è –∑–∞–∑–µ–º–ª–µ–Ω–∏—è –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è</p>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 3: LIGHT (–î—ã—Ö–∞–Ω–∏–µ) -->
            <div class="menu-card card-light" onclick="navigateTo('game')">
                <div class="icon-circle icon-breath">
                    <span class="material-icons-round">filter_drama</span>
                </div>
                <div class="menu-content">
                    <h3>–î—ã—Ö–∞–Ω–∏–µ –æ—Ç –ø–∞–Ω–∏–∫–∏</h3>
                    <p>–ö–æ–≥–¥–∞ –Ω–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ</p>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 4: LIGHT (–î–Ω–µ–≤–Ω–∏–∫) -->
            <div class="menu-card card-light" onclick="navigateTo('music')">
                <div class="icon-circle icon-journal">
                    <span class="material-icons-round">history_edu</span>
                </div>
                <div class="menu-content">
                    <h3>–î–Ω–µ–≤–Ω–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h3>
                    <p>–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞</p>
                </div>
            </div>

        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ß–ê–¢ -->
    <div id="chat-screen" class="screen">
        <div id="chat-container">
            <div class="message msg-bot">–ü—Ä–∏–≤–µ—Ç! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å. –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å? üåø</div>
            <div class="typing-indicator" id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
        <div class="input-area">
            <button id="micBtn" class="btn-circle"><span class="material-icons-round">mic</span></button>
            <input type="text" id="userInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="sendBtn" class="btn-circle"><span class="material-icons-round">send</span></button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –ú–ï–î–ò–¢–ê–¶–ò–ò -->
    <div id="video-screen" class="screen">
        <div class="content-list">
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">spa</span></div>
                <div class="media-info"><h3>–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞</h3><p>5 –º–∏–Ω—É—Ç —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è</p></div>
                <span class="material-icons-round play-btn">play_arrow</span>
            </div>
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">waves</span></div>
                <div class="media-info"><h3>–®—É–º –º–æ—Ä—è</h3><p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–Ω–∞</p></div>
                <span class="material-icons-round play-btn">play_arrow</span>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –ò–ì–†–ê -->
    <div id="game-screen" class="screen">
        <canvas id="breathCanvas"></canvas>
        <div class="game-ui-overlay">
            <div class="breath-text-container">
                <div class="breath-status" id="breathLabel">RELAX</div>
                <div class="breath-timer-text" id="breathInstruction">–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç</div>
            </div>
            <div class="game-controls">
                <button class="btn-game-glass btn-start-glass" id="breathStartBtn" onclick="toggleBreathing()">
                    <span class="material-icons-round" id="playIcon">play_arrow</span>
                    <span id="playText">–°—Ç–∞—Ä—Ç</span>
                </button>
                <button class="btn-game-glass btn-reset-glass" onclick="resetBreathing()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 5: –î–ù–ï–í–ù–ò–ö -->
    <div id="music-screen" class="screen">
        <div class="content-list">
            <div class="media-item">
                <div class="media-icon"><span class="material-icons-round">lock</span></div>
                <div class="media-info"><h3>–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h3><p>–°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...</p></div>
            </div>
        </div>
    </div>

<script>
    // === –õ–û–ì–ò–ö–ê (–û–°–¢–ê–í–õ–ï–ù–ê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ===
    
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ó CSV
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOq4mO0Dgx9PH9AzH8ozKOYcQ0CshNHldt51VyynuR1uJZ8ZW_x71KNhG-4QV6nPF8/exec";

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.onClick(goBack);

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const screens = {
        menu: document.getElementById('menu-screen'),
        chat: document.getElementById('chat-screen'),
        video: document.getElementById('video-screen'),
        music: document.getElementById('music-screen'),
        game: document.getElementById('game-screen')
    };

    const header = document.getElementById('main-header');
    const pageTitle = document.getElementById('page-title');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä—ã
    const breathLabel = document.getElementById('breathLabel');
    const breathInstruction = document.getElementById('breathInstruction');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const breathStartBtn = document.getElementById('breathStartBtn');
    const canvas = document.getElementById('breathCanvas');
    const ctx = canvas.getContext('2d');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∞—Ç–∞
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typing');
    const userId = tg.initDataUnsafe?.user?.id || 'web_user_' + Math.floor(Math.random() * 1000);

    loadChatHistory();

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function navigateTo(screenName, initialMessage = null) {
        Object.values(screens).forEach(el => el.classList.remove('active'));
        screens[screenName].classList.add('active');

        if (screenName === 'menu') {
            header.style.display = 'none'; tg.BackButton.hide();
            stopBreathingAnimationLoop();
        } else {
            header.style.display = 'flex'; tg.BackButton.show();

            if (screenName === 'chat') { 
                pageTitle.innerText = '–ß–∞—Ç'; 
                setTimeout(scrollToBottom, 100); 
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –º–æ–∂–Ω–æ –µ–≥–æ –≤—Å—Ç–∞–≤–∏—Ç—å
                if (initialMessage) {
                   userInput.value = initialMessage;
                   // sendMessage(); // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                }
            }
            else if (screenName === 'video') pageTitle.innerText = '–ú–µ–¥–∏—Ç–∞—Ü–∏–∏';
            else if (screenName === 'music') pageTitle.innerText = '–î–Ω–µ–≤–Ω–∏–∫';
            else if (screenName === 'game') {
                pageTitle.innerText = '–î—ã—Ö–∞–Ω–∏–µ';
                resizeCanvas();
                startBreathingAnimationLoop();
            }
        }
    }

    function goBack() {
        if(screens.game.classList.contains('active')) { resetBreathing(); }
        navigateTo('menu');
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–ß–ê–°–¢–ò–¶–´) ---
    let animationId;
    let particles = [];
    let baseRadius = 110;
    let targetRadius = 110;
    let currentRadius = 110;

    let breathPhase = 'ready';
    let breathInterval = null;
    let breathTimer = 0;
    let isBreathing = false;

    // –¢–∞–π–º–∏–Ω–≥–∏ –¥—ã—Ö–∞–Ω–∏—è (4-7-8)
    const INHALE_TIME = 4;
    const HOLD_TIME = 7;
    const EXHALE_TIME = 8;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initParticles();
    }
    window.addEventListener('resize', resizeCanvas);

    class Particle {
        constructor() {
            this.angle = Math.random() * Math.PI * 2;
            this.distance = baseRadius + Math.random() * 20;
            this.size = Math.random() * 3 + 1;
            this.speed = Math.random() * 0.02 + 0.005;
            this.color = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`;
            this.wobble = Math.random() * 20;
        }

        update(radius, phase) {
            this.angle += this.speed;
            let targetDist = radius + Math.sin(Date.now() / 500 + this.wobble) * 10;

            if (phase === 'inhale') {
                targetDist += Math.random() * 10;
                this.color = `rgba(255, 255, 255, ${Math.random() * 0.7 + 0.3})`;
            } else if (phase === 'hold') {
                targetDist += Math.random() * 2;
                this.color = `rgba(200, 255, 240, ${Math.random() * 0.6 + 0.4})`;
            } else if (phase === 'exhale') {
                this.color = `rgba(255, 255, 255, ${Math.random() * 0.4 + 0.1})`;
            } else {
                this.color = `rgba(255, 255, 255, 0.4)`;
            }

            this.distance += (targetDist - this.distance) * 0.05;
            const cx = canvas.width / 2;
            const cy = (canvas.height / 2) - 60; // –ü–æ–¥–Ω–∏–º–∞–µ–º —Ü–µ–Ω—Ç—Ä –≤—ã—à–µ UI –∫–Ω–æ–ø–æ–∫
            this.x = cx + Math.cos(this.angle) * this.distance;
            this.y = cy + Math.sin(this.angle) * this.distance;
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 200 —á–∞—Å—Ç–∏—Ü –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        for (let i = 0; i < 200; i++) {
            particles.push(new Particle());
        }
    }

    function startBreathingAnimationLoop() {
        if (!animationId) animate();
    }

    function stopBreathingAnimationLoop() {
        cancelAnimationFrame(animationId);
        animationId = null;
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        currentRadius += (targetRadius - currentRadius) * 0.02;
        particles.forEach(p => {
            p.update(currentRadius, breathPhase);
            p.draw();
        });
        animationId = requestAnimationFrame(animate);
    }

    function toggleBreathing() {
        if (isBreathing) stopBreathing();
        else startBreathing();
    }

    function startBreathing() {
        isBreathing = true;
        playIcon.innerText = 'pause';
        playText.innerText = '–ü–∞—É–∑–∞';
        breathStartBtn.classList.add('btn-stop-glass');
        breathStartBtn.classList.remove('btn-start-glass');

        breathInterval = setInterval(() => {
            breathTimer++;
            updateGameLogic();
        }, 1000);
        updateGameLogic();
    }

    function stopBreathing() {
        isBreathing = false;
        clearInterval(breathInterval);
        breathInterval = null;
        playIcon.innerText = 'play_arrow';
        playText.innerText = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        breathStartBtn.classList.remove('btn-stop-glass');
        breathStartBtn.classList.add('btn-start-glass');
    }

    function resetBreathing() {
        stopBreathing();
        breathTimer = 0;
        breathPhase = 'ready';
        targetRadius = 110;
        playText.innerText = '–°—Ç–∞—Ä—Ç';
        playIcon.innerText = 'play_arrow';
        breathLabel.innerText = 'RELAX';
        breathInstruction.innerText = '–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç';
    }

    function updateGameLogic() {
        const cycleTime = breathTimer % (INHALE_TIME + HOLD_TIME + EXHALE_TIME);

        if (cycleTime < INHALE_TIME) {
            breathPhase = 'inhale';
            targetRadius = 180;
            breathLabel.innerText = '–í–î–û–•';
            breathInstruction.innerText = '–ì–ª—É–±–æ–∫–∏–π –≤–¥–æ—Ö...';
        }
        else if (cycleTime < INHALE_TIME + HOLD_TIME) {
            breathPhase = 'hold';
            targetRadius = 190;
            breathLabel.innerText = '–ü–ê–£–ó–ê';
            breathInstruction.innerText = '–ó–∞–¥–µ—Ä–∂–∏ –¥—ã—Ö–∞–Ω–∏–µ...';
        }
        else {
            breathPhase = 'exhale';
            targetRadius = 110;
            breathLabel.innerText = '–í–´–î–û–•';
            breathInstruction.innerText = '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–¥–æ—Ö...';
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ---
    function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
    
    function addMessage(text, isUser = false) {
        const msgDiv = document.createElement('div'); 
        msgDiv.classList.add('message');
        msgDiv.classList.add(isUser ? 'msg-user' : 'msg-bot'); 
        msgDiv.innerHTML = text.replace(/\n/g, '<br>');
        chatContainer.insertBefore(msgDiv, typingIndicator); 
        scrollToBottom();
    }

    function showTyping(show) { 
        typingIndicator.style.display = show ? 'block' : 'none'; 
        scrollToBottom(); 
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    function loadChatHistory() {
        showTyping(true);
        fetch(GOOGLE_SCRIPT_URL + '?act=api', {
            method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
            body: JSON.stringify({ userId: userId, action: 'load_history' })
        })
        .then(r => r.json())
        .then(d => {
            showTyping(false);
            if (d.status === 'success' && d.history) {
                d.history.forEach(i => {
                    const m = document.createElement('div'); m.classList.add('message');
                    m.classList.add(i.role === 'user' ? 'msg-user' : 'msg-bot');
                    m.innerHTML = i.parts[0].text.replace(/\n/g, '<br>');
                    chatContainer.insertBefore(m, typingIndicator);
                });
                scrollToBottom();
            }
        })
        .catch(e => {
            console.error(e);
            showTyping(false);
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
    function sendMessage() {
        const text = userInput.value.trim(); 
        if (!text) return;
        
        addMessage(text, true); 
        userInput.value = ''; 
        sendBtn.disabled = true; 
        showTyping(true);

        fetch(GOOGLE_SCRIPT_URL + '?act=api', {
            method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
            body: JSON.stringify({ text: text, userId: userId, initData: tg.initData })
        })
        .then(r => r.json())
        .then(d => {
            showTyping(false); 
            sendBtn.disabled = false; 
            userInput.focus();
            if (d.status === 'success') {
                addMessage(d.text, false); 
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞—É–¥–∏–æ (TTS), –ø—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                if(d.audio) playAudioResponse(d.audio);
            } else {
                addMessage("‚ö†Ô∏è " + d.text, false);
            }
        })
        .catch(e => { 
            showTyping(false); 
            sendBtn.disabled = false; 
            addMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", false); 
        });
    }
    
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // --- –ì–û–õ–û–°–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï ---
    const micBtn = document.getElementById('micBtn');
    let mediaRecorder, audioChunks = [], isRecording = false, globalStream = null, currentAudio = null;

    micBtn.addEventListener('click', async () => { 
        if (!isRecording) startRecording(); else stopRecording(); 
    });

    async function startRecording() {
        stopCurrentAudio();
        try {
            if (!globalStream || !globalStream.active) {
                globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            }
            mediaRecorder = new MediaRecorder(globalStream); 
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendVoiceMessage;
            
            mediaRecorder.start(); 
            isRecording = true;
            micBtn.classList.add('recording'); 
            micBtn.innerHTML = '<span class="material-icons-round">stop</span>';
            
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            userInput.placeholder = "–ó–∞–ø–∏—Å—å..."; 
            userInput.disabled = true;
        } catch (e) { 
            console.error(e);
            addMessage("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É", false); 
            globalStream = null; 
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop(); 
            isRecording = false;
            micBtn.classList.remove('recording'); 
            micBtn.innerHTML = '<span class="material-icons-round">mic</span>';
            userInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ..."; 
            userInput.disabled = false;
        }
    }

    function sendVoiceMessage() {
        const reader = new FileReader(); 
        showTyping(true);
        // –°–æ–∑–¥–∞–µ–º blob, GAS –æ–∂–∏–¥–∞–µ—Ç audio/webm –¥–ª—è Gemini
        reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
        
        reader.onloadend = () => {
            addMessage("üé§ <i>–ê—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ...</i>", true);
            
            fetch(GOOGLE_SCRIPT_URL + '?act=api', {
                method: 'POST', mode: 'cors', credentials: 'omit', redirect: "follow",
                body: JSON.stringify({ userId: userId, audio: reader.result, initData: tg.initData })
            })
            .then(r => r.json())
            .then(d => {
                showTyping(false);
                if (d.status === 'success') {
                    if(d.recognizedText) addMessage("üó£ " + d.recognizedText, true);
                    addMessage(d.text, false); 
                    if(d.audio) playAudioResponse(d.audio);
                } else {
                    addMessage("‚ö†Ô∏è " + d.text, false);
                }
            })
            .catch(e => { 
                showTyping(false); 
                addMessage("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ", false); 
            });
        };
    }

    function stopCurrentAudio() { 
        if (currentAudio) { currentAudio.pause(); currentAudio = null; } 
    }

    function playAudioResponse(base64) {
        stopCurrentAudio(); 
        // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –∏–∑ Base64 –æ—Ç–≤–µ—Ç–∞ (MP3 –æ—Ç OpenAI)
        currentAudio = new Audio("data:audio/mp3;base64," + base64);
        currentAudio.play().catch(e => console.log("Audio autoplay blocked: ", e));
        currentAudio.onended = () => { currentAudio = null; };
    }
</script>
</body>
</html>
