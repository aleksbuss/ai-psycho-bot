<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mental Health AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            /* --- –ü–ê–õ–ò–¢–†–ê FRESH MINT --- */
            --bg-main: #F5F7FA;      
            --bg-card: #FFFFFF;      
            
            --text-header: #1F2937;  
            --text-body: #4B5563;    
            --text-muted: #9CA3AF;   
            
            --primary-main: #4DB6AC; 
            --primary-soft: #E0F2F1; 
            --primary-text: #00695C; 
            
            /* –ì–û–õ–£–ë–û–ô */
            --secondary-bg: #E3F2FD; 
            --secondary-accent: #64B5F6;
            --secondary-text: #1565C0;
            
            --warm-bg: #FFF3E0;
            --warm-accent: #FFB74D;
            --warm-text: #EF6C00;

            --radius-card: 24px;
            --radius-btn-sq: 18px;
            
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.04);
            --shadow-float: 0 10px 30px rgba(77, 182, 172, 0.15);
            --shadow-float-blue: 0 10px 30px rgba(100, 181, 246, 0.25);
            
            --icon-default: #90A4AE;
            
            --msg-bot-bg: #FFFFFF;
            --msg-user-bg: #4DB6AC;
            --msg-user-text: #FFFFFF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-body);
            line-height: 1.5;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }

        h1, h2, h3, h4 { color: var(--text-header); font-weight: 600; letter-spacing: -0.02em; }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        .anim-eye { transform-origin: center; animation: blink 4s infinite; }
        @keyframes handWave { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .anim-hand { transform-origin: bottom center; animation: handWave 3s ease-in-out infinite; }
        @keyframes soundFlow { 0% { opacity: 0; transform: translateX(-5px); } 50% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(5px); } }
        .sound-line-1 { animation: soundFlow 1.5s infinite 0s; } .sound-line-2 { animation: soundFlow 1.5s infinite 0.3s; } .sound-line-3 { animation: soundFlow 1.5s infinite 0.6s; }
        @keyframes scentRise { 0% { transform: translateY(0) scaleX(1); opacity: 0.6; } 100% { transform: translateY(-15px) scaleX(1.2); opacity: 0; } }
        .scent-line { animation: scentRise 2.5s infinite linear; }
        @keyframes candyPulse { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.1) rotate(5deg); } }
        .anim-candy { transform-origin: center; animation: candyPulse 3s ease-in-out infinite; }

        @keyframes waveMove { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes msgSlideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .msg-enter { animation: msgSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .equalizer { display: flex; align-items: flex-end; gap: 2px; height: 16px; width: 16px; }
        .eq-bar { width: 4px; background-color: var(--primary-main); border-radius: 2px; animation: eqBounce 0.5s infinite ease-in-out alternate; }
        .eq-bar:nth-child(1) { height: 60%; animation-delay: 0s; } .eq-bar:nth-child(2) { height: 100%; animation-delay: 0.2s; } .eq-bar:nth-child(3) { height: 80%; animation-delay: 0.4s; }
        @keyframes eqBounce { 0% { height: 30%; } 100% { height: 100%; } }

        .fade-out-scale { animation: fadeOutScale 0.3s ease-in forwards; }
        .fade-in-scale { animation: fadeInScale 0.4s ease-out forwards; }
        @keyframes fadeOutScale { to { opacity: 0; transform: scale(0.9); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- UI COMPONENTS --- */
        header { padding: 0 20px; background: transparent; z-index: 100; display: none; align-items: center; height: 60px; flex-shrink: 0; width: 100%; }
        
        #back-btn { 
            background: var(--primary-main); 
            border: none; color: white; width: 44px; height: 44px; border-radius: 14px; 
            box-shadow: 0 4px 15px rgba(77, 182, 172, 0.4); 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: transform 0.1s;
        }
        #back-btn:active { transform: scale(0.95); }

        .header-title { font-size: 18px; font-weight: 600; margin-left: 15px; color: var(--text-header); }
        .screen { flex: 1; display: none; flex-direction: column; width: 100%; height: 100%; overflow: hidden; position: relative; }
        .screen.active { display: flex; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        #menu-screen { padding: 24px; overflow-y: auto; }
        .greeting-header { margin-top: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .greeting-text h1 { font-size: 26px; line-height: 1.3; }
        .greeting-text p { font-size: 16px; color: var(--text-muted); margin-top: 4px; }
        .sos-btn-header { width: 54px; height: 54px; border-radius: 18px; background-color: var(--warm-bg); display: flex; align-items: center; justify-content: center; color: var(--warm-text); font-weight: 800; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 4px 15px rgba(255, 183, 77, 0.25); cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; border: none; }
        .sos-btn-header:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(255, 183, 77, 0.2); }
        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 16px; color: var(--text-header); }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .action-card { border-radius: var(--radius-card); padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 150px; cursor: pointer; transition: transform 0.1s; background-color: var(--primary-soft); }
        .action-card:active { transform: scale(0.97); }
        .card-chat h3 { color: var(--primary-text); }
        .card-chat .icon-box { color: var(--primary-main); border: 1px solid rgba(77, 182, 172, 0.2); }
        .card-breath { background-color: var(--secondary-bg); }
        .card-breath h3 { color: #1565C0; }
        .card-breath .icon-box { color: var(--secondary-accent); border: 1px solid rgba(100, 181, 246, 0.2); }
        .icon-box { width: 50px; height: 50px; border-radius: 16px; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .icon-box span { font-size: 26px; }
        .action-card h3 { font-size: 15px; font-weight: 600; }
        .widget-card { background: #E0F2F1; border-radius: var(--radius-card); padding: 20px; margin-bottom: 24px; position: relative; overflow: hidden; cursor: pointer; }
        .widget-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .dot-indicator { width: 8px; height: 8px; background: var(--primary-main); border-radius: 50%; opacity: 0.8; }
        .widget-title { font-size: 14px; color: var(--text-muted); }
        .widget-main-text { font-size: 18px; font-weight: 600; color: var(--text-header); }
        .wave-container { width: 100%; height: 50px; margin-top: 8px; overflow: hidden; position: relative; }
        .wave-graph { width: 200%; height: 100%; opacity: 0.9; animation: waveMove 8s linear infinite; }
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .small-card { background: var(--bg-card); padding: 16px; border-radius: 20px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-card); cursor: pointer; position: relative; }
        .small-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .warm-icon { background: var(--warm-bg); color: var(--warm-accent); }
        .mint-icon { background: var(--primary-soft); color: var(--primary-main); }
        .small-card h4 { font-size: 14px; font-weight: 600; color: var(--text-header); }
        .small-card span { font-size: 11px; color: var(--text-muted); }
        .notification-dot { position: absolute; top: 12px; right: 12px; width: 10px; height: 10px; background-color: #FF7043; border-radius: 50%; border: 2px solid var(--bg-card); display: none; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* SOS SCREEN */
        #sos-screen { background-color: var(--primary-soft); justify-content: center; }
        .sos-dynamic-container { padding: 24px; display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center; }
        .sos-dynamic-card { background: #FFF3E0; padding: 40px 24px; border-radius: 32px; box-shadow: 0 10px 40px rgba(77, 182, 172, 0.1); width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center; opacity: 0; transform: translateY(20px); }
        .anim-enter { animation: sosCardEnter 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes sosCardEnter { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim-exit { animation: sosCardExit 0.5s ease-in forwards; }
        @keyframes sosCardExit { to { opacity: 0; transform: translateX(-100%); } }
        .sos-group-1, .sos-group-2, .sos-group-3 { opacity: 0; }
        .fade-in-up { animation: sosContentFadeIn 0.5s ease-out forwards; }
        @keyframes sosContentFadeIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .delay-1 { animation-delay: 0.2s; } .delay-2 { animation-delay: 0.3s; } .delay-3 { animation-delay: 0.4s; }
        .sos-number { font-size: 80px; font-weight: 800; color: var(--secondary-text); line-height: 1; margin-bottom: 10px; }
        .sos-illustration-container { width: 120px; height: 120px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; }
        .sos-svg { width: 100%; height: 100%; stroke: var(--secondary-text); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .sos-instruction { font-size: 20px; color: var(--text-header); font-weight: 700; margin-bottom: 8px; }
        .sos-subtext { font-size: 16px; color: var(--text-body); margin-bottom: 30px; }
        .sos-next-btn { width: 100%; padding: 18px; border-radius: 24px; border: none; background: var(--primary-main); color: white; font-size: 17px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(77, 182, 172, 0.3); transition: transform 0.1s; }
        .sos-next-btn:active { transform: scale(0.97) !important; }
        .sos-finish-container { text-align: center; display: none; width: 100%; flex-direction: column; align-items: center; animation: sosCardEnter 0.6s ease-out; }
        .sos-finish-icon { font-size: 90px; color: var(--primary-main); margin-bottom: 20px; }

        /* CHAT */
        #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .message { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 15px; box-shadow: var(--shadow-card); }
        .msg-bot { align-self: flex-start; background-color: var(--msg-bot-bg); color: var(--text-body); border-top-left-radius: 4px; }
        .msg-user { align-self: flex-end; background-color: var(--msg-user-bg); color: var(--msg-user-text); border-top-right-radius: 4px; box-shadow: 0 4px 12px rgba(77, 182, 172, 0.3); }
        .typing-indicator { display: none; align-self: flex-start; background: var(--bg-card); padding: 12px; border-radius: 16px; margin-bottom: 10px; box-shadow: var(--shadow-card); }
        .dot { height: 6px; width: 6px; background-color: #CFD8DC; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        .input-area { width: 100%; background: var(--bg-main); padding: 10px 16px; display: flex; align-items: center; justify-content: center; gap: 12px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); box-sizing: border-box; }
        input[type="text"] { flex: 1; min-width: 0; padding: 0 20px; height: 54px; border-radius: 18px; border: none; font-size: 16px; outline: none; background: #FFFFFF; box-shadow: 0 2px 10px rgba(0,0,0,0.03); color: var(--text-header); box-sizing: border-box; }
        .btn-sq { width: 54px; height: 54px; border-radius: var(--radius-btn-sq); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .btn-sq:active { transform: scale(0.94); }
        #micBtn { background-color: #FFFFFF; color: var(--icon-default); box-shadow: var(--shadow-card); }
        #micBtn.recording { background-color: var(--primary-soft); color: var(--primary-main); animation: pulse-mint 2s infinite; border: 1px solid var(--primary-main); }
        #sendBtn { background: var(--primary-main); color: white; box-shadow: 0 4px 15px rgba(77, 182, 172, 0.3); }

        /* DIARY */
        .mood-selector { display: flex; gap: 15px; margin-bottom: 30px; }
        .mood-btn { flex: 1; height: 140px; border-radius: var(--radius-card); border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; box-shadow: var(--shadow-card); }
        .mood-btn:active { transform: scale(0.97); }
        .mood-good { background-color: var(--primary-soft); color: var(--primary-text); }
        .mood-good span { font-size: 40px; margin-bottom: 10px; color: var(--primary-main); }
        .mood-bad { background-color: var(--warm-bg); color: var(--warm-text); }
        .mood-bad span { font-size: 40px; margin-bottom: 10px; color: var(--warm-accent); }
        .mood-btn h3 { font-size: 16px; margin: 0; }
        .today-summary { background: white; border-radius: var(--radius-card); padding: 24px; text-align: center; margin-bottom: 30px; box-shadow: var(--shadow-card); display: none; }
        .today-summary .icon-lg { font-size: 48px; margin-bottom: 10px; display: block; }
        .today-summary h3 { font-size: 18px; margin-bottom: 5px; }
        .today-summary p { color: var(--text-muted); font-size: 14px; }
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { background: var(--bg-card); padding: 16px 20px; border-radius: 18px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-card); }
        .h-date { font-weight: 600; color: var(--text-header); font-size: 15px; }
        .h-status { font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 12px; }
        .status-good { background: var(--primary-soft); color: var(--primary-text); }
        .status-bad { background: var(--warm-bg); color: var(--warm-text); }

        /* LISTS */
        .content-list { padding: 24px; overflow-y: auto; flex: 1; }
        .media-item { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); margin-bottom: 16px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow-card); cursor: pointer; transition: transform 0.1s; }
        .media-item:active { transform: scale(0.98); }
        .media-icon { width: 44px; height: 44px; background: #ECEFF1; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--icon-default); }
        .media-info h3 { font-size: 16px; margin-bottom: 4px; color: var(--text-header); }
        .media-info p { font-size: 13px; color: var(--text-muted); }
        .play-btn-container { margin-left: auto; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--primary-main); }
        
        /* BREATHING GAME SCREEN */
        #game-screen { background: var(--primary-soft); } /* –ú–Ø–¢–ù–´–ô –§–û–ù */
        #game-screen .breath-status { color: var(--text-header); text-shadow: none; font-weight: 700; margin-bottom: 8px; }
        #game-screen .breath-timer-text { color: var(--text-muted); font-weight: 500; }
        .btn-game-card { padding: 20px 40px; border-radius: var(--radius-card); border: none; font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 14px; background: var(--secondary-bg); color: var(--secondary-text); box-shadow: var(--shadow-float-blue); transition: all 0.2s; min-width: 160px; justify-content: center; }
        .btn-game-card:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(100, 181, 246, 0.2); }
        .btn-game-card span { font-size: 26px; }
        .btn-reset-sq { width: 64px; height: 64px; padding: 0; border-radius: 20px; background: var(--secondary-bg); color: var(--secondary-text); border: none; box-shadow: var(--shadow-float-blue); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .btn-reset-sq:active { transform: rotate(45deg) scale(0.92); }
        
        canvas#breathCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.6; }
        .game-ui-overlay { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; width: 100%; padding-bottom: 80px; pointer-events: none; }
        .breath-text-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 40px; }
        .game-controls { pointer-events: auto; display: flex; gap: 20px; align-items: center; }

        /* BALLOON GAME SCREEN */
        #balloon-game-screen {
            background-color: var(--primary-soft);
            position: relative;
            overflow: hidden;
        }
        #balloon-game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }
        .game-ui-header {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 20px; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none;
        }
        .score-box {
            background: white; padding: 8px 16px; border-radius: 16px;
            box-shadow: var(--shadow-card);
            font-weight: 700; color: var(--primary-text); font-size: 18px;
        }
        .game-ui-header #back-btn-game { pointer-events: auto; }

    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê -->
    <header id="main-header">
        <button id="back-btn" onclick="goBack()">
            <span class="material-icons-round">arrow_back</span>
        </button>
        <span class="header-title" id="page-title">–ù–∞–∑–∞–¥</span>
    </header>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="menu-screen" class="screen active">
        <div class="greeting-header">
            <div class="greeting-text">
                <h1>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,<br>User</h1>
                <p>–ß—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç –≤–∞—Å —Å–µ–≥–æ–¥–Ω—è?</p>
            </div>
            <button class="sos-btn-header" onclick="navigateTo('sos')">SOS</button>
        </div>

        <div class="main-grid">
            <div class="action-card card-chat" onclick="navigateTo('chat')">
                <div class="icon-box"><span class="material-icons-round">chat_bubble_outline</span></div>
                <h3>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h3>
            </div>
            <div class="action-card card-breath" onclick="navigateTo('game')">
                <div class="icon-box"><span class="material-icons-round">air</span></div>
                <h3>–î—ã—Ö–∞–Ω–∏–µ</h3>
            </div>
        </div>

        <div class="section-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
        <div class="widget-card" onclick="navigateTo('video')">
            <div class="widget-header">
                <div class="dot-indicator"></div>
                <div class="widget-title">–ú–µ–¥–∏—Ç–∞—Ü–∏–∏</div>
            </div>
            <div class="widget-main-text">–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</div>
            <div class="wave-container">
                <svg class="wave-graph" viewBox="0 0 600 50" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#4DB6AC;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#4DB6AC;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <path d="M0,25 Q75,5 150,25 T300,25 T450,25 T600,25 V50 H0 Z" fill="url(#grad1)" />
                    <path d="M0,25 Q75,5 150,25 T300,25 T450,25 T600,25" stroke="#4DB6AC" stroke-width="2" fill="none"/>
                </svg>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="small-card" onclick="navigateTo('music')">
                <div style="position:relative;">
                    <div class="small-icon warm-icon"><span class="material-icons-round">favorite_border</span></div>
                    <div id="diaryBadge" class="notification-dot"></div>
                </div>
                <div><h4>–î–Ω–µ–≤–Ω–∏–∫</h4><span>–ó–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ</span></div>
            </div>
            <div class="small-card" onclick="navigateTo('balloons')">
                <div class="small-icon mint-icon"><span class="material-icons-round">sports_esports</span></div>
                <div><h4>–ò–≥—Ä–∞</h4><span>–õ–æ–ø–∞–π —à–∞—Ä–∏–∫–∏</span></div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ß–ê–¢ -->
    <div id="chat-screen" class="screen">
        <div id="chat-container">
            <div class="message msg-bot">–Ø —Ä—è–¥–æ–º. –í—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –º–Ω–µ –≤—Å–µ, —á—Ç–æ –≤–∞—Å —Ç—Ä–µ–≤–æ–∂–∏—Ç. –ú—ã —Å–ø—Ä–∞–≤–∏–º—Å—è. üåø</div>
            <div class="typing-indicator" id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
        <div class="input-area">
            <button id="micBtn" class="btn-sq"><span class="material-icons-round">mic</span></button>
            <input type="text" id="userInput" placeholder="–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å..." autocomplete="off">
            <button id="sendBtn" class="btn-sq"><span class="material-icons-round">arrow_upward</span></button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù SOS -->
    <div id="sos-screen" class="screen">
        <div class="sos-dynamic-container">
            <div id="sos-card-wrapper" class="sos-dynamic-card"></div>
            <div id="sos-finish-area" class="sos-finish-container">
                <span class="material-icons-round sos-finish-icon">check_circle</span>
                <h2 class="section-title" style="text-align: center; margin-bottom:10px;">–û—Ç–ª–∏—á–Ω–æ!</h2>
                <p style="text-align:center; color:var(--text-body); margin-bottom:30px;">
                    –í—ã –∑–∞–∑–µ–º–ª–∏–ª–∏—Å—å. –•–æ—Ç–∏—Ç–µ –ø–æ–¥—ã—à–∞—Ç—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é?
                </p>
                <div style="display:flex; gap:15px; width:100%;">
                    <button class="sos-next-btn" style="background:white; color:var(--text-body); box-shadow:var(--shadow-card);" onclick="goBack()">–í –º–µ–Ω—é</button>
                    <button class="sos-next-btn" onclick="navigateTo('game')">–î—ã—Ö–∞–Ω–∏–µ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –ú–ï–î–ò–¢–ê–¶–ò–ò -->
    <div id="video-screen" class="screen">
        <div class="content-list">
            <h2 class="section-title" style="margin-top:0;">–ü—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–∫–æ—è</h2>
            <div class="media-item" onclick="playMockAudio(this)">
                <div class="media-icon"><span class="material-icons-round">self_improvement</span></div>
                <div class="media-info"><h3>–û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ</h3><p>5 –º–∏–Ω—É—Ç</p></div>
                <div class="play-btn-container"><span class="material-icons-round">play_arrow</span></div>
            </div>
            <div class="media-item" onclick="playMockAudio(this)">
                <div class="media-icon"><span class="material-icons-round">bedtime</span></div>
                <div class="media-info"><h3>–ü–µ—Ä–µ–¥ —Å–Ω–æ–º</h3><p>10 –º–∏–Ω—É—Ç</p></div>
                <div class="play-btn-container"><span class="material-icons-round">play_arrow</span></div>
            </div>
            <div class="media-item" onclick="playMockAudio(this)">
                <div class="media-icon"><span class="material-icons-round">forest</span></div>
                <div class="media-info"><h3>–ó–≤—É–∫–∏ –ø—Ä–∏—Ä–æ–¥—ã</h3><p>–†–µ–ª–∞–∫—Å</p></div>
                <div class="play-btn-container"><span class="material-icons-round">play_arrow</span></div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –î–´–•–ê–ù–ò–ï -->
    <div id="game-screen" class="screen">
        <canvas id="breathCanvas"></canvas>
        <div class="game-ui-overlay">
            <div class="breath-text-container">
                <div class="breath-status" id="breathLabel">–î–´–®–ò–ú</div>
                <div class="breath-timer-text" id="breathInstruction">–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç</div>
            </div>
            <div class="game-controls">
                <button class="btn-game-card" id="breathStartBtn" onclick="toggleBreathing()">
                    <span class="material-icons-round" id="playIcon">play_arrow</span>
                    <span id="playText">–°—Ç–∞—Ä—Ç</span>
                </button>
                <button class="btn-reset-sq" onclick="resetBreathing()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 5: –î–ù–ï–í–ù–ò–ö -->
    <div id="music-screen" class="screen">
        <div class="content-list">
            <div id="diary-question-block">
                <h2 class="section-title" style="margin-top:0; font-size:20px;">–ö–∞–∫ –ø—Ä–æ—à–µ–ª –¥–µ–Ω—å?</h2>
                <div class="mood-selector">
                    <button class="mood-btn mood-good" onclick="saveMood('good')">
                        <span class="material-icons-round">sentiment_satisfied_alt</span>
                        <h3>–•–æ—Ä–æ—à–æ</h3>
                    </button>
                    <button class="mood-btn mood-bad" onclick="saveMood('bad')">
                        <span class="material-icons-round">sentiment_dissatisfied</span>
                        <h3>–¢—è–∂–µ–ª–æ</h3>
                    </button>
                </div>
            </div>
            <div id="diary-summary-block" class="today-summary">
                <span id="summary-icon" class="material-icons-round icon-lg">check_circle</span>
                <h3 id="summary-title">–î–µ–Ω—å –∑–∞–ø–∏—Å–∞–Ω</h3>
                <p>–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –æ—Ç–º–µ—Ç–∏–ª–∏ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</p>
            </div>
            <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è</h2>
            <div class="history-list" id="history-container"></div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 6: –ò–ì–†–ê (–®–ê–†–ò–ö–ò) -->
    <div id="balloon-game-screen" class="screen">
        <div class="game-ui-header">
            <button id="back-btn-game" onclick="goBack()" style="background:var(--primary-main); border:none; border-radius:14px; width:44px; height:44px; box-shadow:var(--shadow-card); display:flex; align-items:center; justify-content:center;">
                <span class="material-icons-round" style="color:white;">arrow_back</span>
            </button>
            <div class="score-box" id="balloon-score">0</div>
        </div>
        <canvas id="balloon-game-canvas"></canvas>
    </div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOq4mO0Dgx9PH9AzH8ozKOYcQ0CshNHldt51VyynuR1uJZ8ZW_x71KNhG-4QV6nPF8/exec";
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.onClick(goBack);

    const screens = {
        menu: document.getElementById('menu-screen'),
        chat: document.getElementById('chat-screen'),
        video: document.getElementById('video-screen'),
        music: document.getElementById('music-screen'),
        game: document.getElementById('game-screen'),
        sos: document.getElementById('sos-screen'),
        balloons: document.getElementById('balloon-game-screen')
    };

    const header = document.getElementById('main-header');
    const pageTitle = document.getElementById('page-title');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä—ã –î—ã—Ö–∞–Ω–∏–µ
    const breathLabel = document.getElementById('breathLabel');
    const breathInstruction = document.getElementById('breathInstruction');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const breathStartBtn = document.getElementById('breathStartBtn');
    const breathCanvas = document.getElementById('breathCanvas'); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è
    const ctx = breathCanvas.getContext('2d');

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typing');
    const userId = tg.initDataUnsafe?.user?.id || 'web_user_' + Math.floor(Math.random() * 1000);
    const userName = tg.initDataUnsafe?.user?.first_name || '–î—Ä—É–≥';

    document.querySelector('.greeting-text h1').innerHTML = `–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,<br>${userName}`;

    checkDailyStatus();
    loadChatHistory();

    function navigateTo(screenName, initialMessage = null) {
        Object.values(screens).forEach(el => el.classList.remove('active'));
        screens[screenName].classList.add('active');

        if (screenName === 'menu') {
            header.style.display = 'none'; tg.BackButton.hide();
            stopBreathingAnimationLoop();
            stopBalloonGame(); 
            checkDailyStatus();
        } else {
            if(screenName === 'balloons') {
                header.style.display = 'none';
                initBalloonGame();
            } else {
                header.style.display = 'flex'; tg.BackButton.show();
            }
            
            if (screenName === 'chat') { 
                pageTitle.innerText = '–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏'; setTimeout(scrollToBottom, 100); 
                if (initialMessage && initialMessage !== '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å') userInput.value = initialMessage;
            }
            else if (screenName === 'video') pageTitle.innerText = '–ú–µ–¥–∏—Ç–∞—Ü–∏–∏';
            else if (screenName === 'music') { pageTitle.innerText = '–î–Ω–µ–≤–Ω–∏–∫'; renderDiaryScreen(); }
            else if (screenName === 'game') { pageTitle.innerText = '–î—ã—Ö–∞–Ω–∏–µ'; resizeBreathCanvas(); startBreathingAnimationLoop(); }
            else if (screenName === 'sos') { pageTitle.innerText = '–ó–∞–∑–µ–º–ª–µ–Ω–∏–µ'; resetSos(); }
        }
    }

    function goBack() {
        if(screens.game.classList.contains('active')) { resetBreathing(); }
        navigateTo('menu');
    }

    // --- –õ–û–ì–ò–ö–ê SOS ---
    const sosSteps = [
        { num: 5, title: '–ù–∞–π–¥–∏ –≥–ª–∞–∑–∞–º–∏', text: '5 –≤–µ—â–µ–π –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞' },
        { num: 4, title: '–ü–æ—á—É–≤—Å—Ç–≤—É–π', text: '4 –æ—â—É—â–µ–Ω–∏—è –Ω–∞ –∫–æ–∂–µ' },
        { num: 3, title: '–£—Å–ª—ã—à—å', text: '3 –ª—é–±—ã—Ö –∑–≤—É–∫–∞ –≤–æ–∫—Ä—É–≥' },
        { num: 2, title: '–ü–æ—á—É–≤—Å—Ç–≤—É–π', text: '2 –∑–∞–ø–∞—Ö–∞' },
        { num: 1, title: '–û—â—É—Ç–∏', text: '1 –≤–∫—É—Å (–≤–æ–¥–∞ –∏–ª–∏ –∫–æ–Ω—Ñ–µ—Ç–∞)' }
    ];
    let currentSosIndex = 0;
    function getSosSvg(stepNum) {
        switch(stepNum) {
            case 5: return `<svg class="sos-svg anim-eye" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
            case 4: return `<svg class="sos-svg anim-hand" viewBox="0 0 24 24"><path d="M21.99 13.06l-1.92-6.52c-.22-.76-.89-1.28-1.68-1.28H18V4c0-1.1-.9-2-2-2s-2 .9-2 2v8.94l-.3-.02-.1-.01c-.8 0-1.55.23-2.21.62L11 11.23V4c0-1.1-.9-2-2-2S7 2.9 7 4v10.5c0 2.21 1.79 4 4 4s4-1.79 4-4V5c0-.55.45-1 1-1s1 .45 1 1v9.5c0 .35.18.68.49.86.3.19.68.2.98.02.31-.18.49-.52.49-.88V6.52c0-.13.11-.24.23-.24.08 0 .15.04.19.11l2.43 8.26c.2.68.83 1.15 1.54 1.15.88 0 1.6-.72 1.6-1.6 0-.05-.01-.1-.01-.14z"/></svg>`;
            case 3: return `<svg class="sos-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/><path class="sound-line-1" d="M16 11l2-3" stroke-width="2" stroke-linecap="round"/><path class="sound-line-2" d="M18 13l3-2" stroke-width="2" stroke-linecap="round"/><path class="sound-line-3" d="M17 15l2 1" stroke-width="2" stroke-linecap="round"/></svg>`;
            case 2: return `<svg class="sos-svg" viewBox="0 0 24 24"><path d="M12 22c4.97 0 9-4.03 9-9-4.97 0-9-4.03-9-9-4.97 0-9 4.03-9 9 0 4.97 4.03 9 9 9z" fill="none" stroke="currentColor"/><path d="M12 13c.88 0 1.61.59 1.88 1.4.16.48.59.83 1.12.83.67 0 1.18-.55 1.18-1.22 0-1.57-2.18-2-2.18-4.01 0-1.12.85-2.03 1.94-2.18C15.42 7.73 15 7.42 15 7c0-.55.45-1 1-1s1 .45 1 1c0 .42-.42.73-1.06.82-1.63.22-2.94 1.64-2.94 3.36 0 1.42 1.68 1.93 1.68 2.83 0 .16-.16.22-.18.22-.05 0-.12-.04-.15-.14-.26-1.07-1.24-1.87-2.35-1.87s-2.09.79-2.35 1.87c-.03.1-.1.14-.15.14-.02 0-.18-.06-.18-.22 0-.9 1.68-1.41 1.68-2.83 0-1.72-1.31-3.14-2.94-3.36C8.42 7.73 8 7.42 8 7c0-.55.45-1 1-1s1 .45 1 1c0 .42-.42.73-.94.82C10.15 7.97 11 8.88 11 10c0 2.01-2.18 2.44-2.18 4.01 0 .67.51 1.22 1.18 1.22.53 0 .96-.35 1.12-.83.27-.81 1-1.4 1.88-1.4z"/><path class="scent-line" d="M12 6V2"/></svg>`;
            case 1: return `<svg class="sos-svg anim-candy" viewBox="0 0 24 24"><path d="M18 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm-6-2.25c-2.07 0-3.75 1.68-3.75 3.75s1.68 3.75 3.75 3.75 3.75-1.68 3.75-3.75-1.68-3.75-3.75-3.75zm0 6c-1.24 0-2.25-1.01-2.25-2.25S10.76 9.75 12 9.75 14.25 10.76 14.25 12 13.24 14.25 12 14.25zM6 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/></svg>`;
        }
    }
    function resetSos() { currentSosIndex = 0; document.getElementById('sos-finish-area').style.display = 'none'; const card = document.getElementById('sos-card-wrapper'); card.style.display = 'flex'; card.className = 'sos-dynamic-card'; renderSosStep(true); }
    function renderSosStep(isFirst = false) { const step = sosSteps[currentSosIndex]; const card = document.getElementById('sos-card-wrapper'); card.classList.remove('anim-exit'); void card.offsetWidth; card.classList.add('anim-enter'); card.innerHTML = `<div class="sos-group-1 fade-in-up delay-1 anim-breathe"><div class="sos-number">${step.num}</div><div class="sos-illustration-container">${getSosSvg(step.num)}</div></div><div class="sos-group-2 fade-in-up delay-2"><div class="sos-instruction">${step.title}</div><div class="sos-subtext">${step.text}</div></div><div class="sos-group-3 fade-in-up delay-3" style="width:100%"><button class="sos-next-btn" onclick="animateSosExit()">–Ø –Ω–∞—à–µ–ª</button></div>`; }
    function animateSosExit() { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); const card = document.getElementById('sos-card-wrapper'); card.classList.remove('anim-enter'); card.classList.add('anim-exit'); setTimeout(() => { if (currentSosIndex < sosSteps.length - 1) { currentSosIndex++; renderSosStep(); } else { card.style.display = 'none'; document.getElementById('sos-finish-area').style.display = 'flex'; if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); } }, 450); }

    // --- DIARY LOGIC ---
    function getTodayString() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function checkDailyStatus() { const h = JSON.parse(localStorage.getItem('mood_history') || '{}'); document.getElementById('diaryBadge').style.display = h[getTodayString()] ? 'none' : 'block'; }
    function saveMood(s) { const h = JSON.parse(localStorage.getItem('mood_history') || '{}'); h[getTodayString()] = s; localStorage.setItem('mood_history', JSON.stringify(h)); if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); document.getElementById('diary-question-block').classList.add('fade-out-scale'); setTimeout(() => { renderDiaryScreen(true); checkDailyStatus(); }, 300); }
    function renderDiaryScreen(anim) { const t = getTodayString(), h = JSON.parse(localStorage.getItem('mood_history') || '{}'), q = document.getElementById('diary-question-block'), s = document.getElementById('diary-summary-block'); q.classList.remove('fade-out-scale'); s.classList.remove('fade-in-scale'); if(h[t]) { q.style.display='none'; s.style.display='block'; if(anim) s.classList.add('fade-in-scale'); document.getElementById('summary-title').innerText = h[t]==='good'?'–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å':'–¢—è–∂–µ–ª—ã–π –¥–µ–Ω—å'; document.getElementById('summary-icon').innerText = h[t]==='good'?'sentiment_satisfied_alt':'sentiment_dissatisfied'; document.getElementById('summary-icon').style.color = h[t]==='good'?'var(--primary-main)':'var(--warm-text)'; } else { q.style.display='block'; s.style.display='none'; } const c = document.getElementById('history-container'); c.innerHTML=''; Object.keys(h).sort((a,b)=>new Date(b)-new Date(a)).forEach(d=>{ const div=document.createElement('div'); div.className='history-item'; div.innerHTML=`<span class="h-date">${d}</span><span class="h-status ${h[d]==='good'?'status-good':'status-bad'}">${h[d]==='good'?'–•–æ—Ä–æ—à–æ':'–¢—è–∂–µ–ª–æ'}</span>`; c.appendChild(div); }); }

    // --- BALLOON GAME LOGIC ---
    let balloonCanvas, bCtx, balloons = [], confetti = [], balloonLoopId, score = 0;
    
    function initBalloonGame() {
        balloonCanvas = document.getElementById('balloon-game-canvas');
        bCtx = balloonCanvas.getContext('2d');
        resizeBalloonCanvas();
        window.addEventListener('resize', resizeBalloonCanvas);
        balloonCanvas.addEventListener('touchstart', handleBalloonTap);
        balloonCanvas.addEventListener('mousedown', handleBalloonTap);
        score = 0; document.getElementById('balloon-score').innerText = score;
        balloons = []; confetti = [];
        startBalloonLoop();
    }
    function stopBalloonGame() { cancelAnimationFrame(balloonLoopId); window.removeEventListener('resize', resizeBalloonCanvas); }
    function resizeBalloonCanvas() { balloonCanvas.width = window.innerWidth; balloonCanvas.height = window.innerHeight; }
    class Balloon { constructor() { this.radius = 35; this.x = Math.random() * (balloonCanvas.width - this.radius * 2) + this.radius; this.y = balloonCanvas.height + this.radius; this.speed = Math.random() * 2 + 3; this.wobble = Math.random() * Math.PI * 2; this.color = 'white'; } update() { this.y -= this.speed; this.x += Math.sin(this.wobble) * 1; this.wobble += 0.05; } draw() { bCtx.beginPath(); bCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); bCtx.fillStyle = this.color; bCtx.fill(); bCtx.beginPath(); bCtx.arc(this.x - 10, this.y - 10, 5, 0, Math.PI * 2); bCtx.fillStyle = 'rgba(255,255,255,0.8)'; bCtx.fill(); bCtx.beginPath(); bCtx.moveTo(this.x, this.y + this.radius); bCtx.quadraticCurveTo(this.x + Math.sin(this.wobble)*10, this.y + this.radius + 20, this.x, this.y + this.radius + 40); bCtx.strokeStyle = 'rgba(0,0,0,0.2)'; bCtx.stroke(); } }
    class ConfettiParticle { constructor(x, y) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.velocity = Math.random() * 5 + 2; this.size = Math.random() * 5 + 2; this.color = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'][Math.floor(Math.random() * 5)]; this.life = 1.0; } update() { this.x += Math.cos(this.angle) * this.velocity; this.y += Math.sin(this.angle) * this.velocity; this.life -= 0.03; } draw() { bCtx.globalAlpha = this.life; bCtx.fillStyle = this.color; bCtx.fillRect(this.x, this.y, this.size, this.size); bCtx.globalAlpha = 1.0; } }
    function handleBalloonTap(e) { e.preventDefault(); const rect = balloonCanvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const x = clientX - rect.left; const y = clientY - rect.top; for (let i = balloons.length - 1; i >= 0; i--) { const b = balloons[i]; const dist = Math.sqrt((x - b.x)**2 + (y - b.y)**2); if (dist < b.radius + 15) { for(let k=0; k<15; k++) confetti.push(new ConfettiParticle(b.x, b.y)); balloons.splice(i, 1); score++; document.getElementById('balloon-score').innerText = score; if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); return; } } }
    function startBalloonLoop() { bCtx.clearRect(0, 0, balloonCanvas.width, balloonCanvas.height); if (Math.random() < 0.03) balloons.push(new Balloon()); balloons.forEach((b, i) => { b.update(); b.draw(); if (b.y + b.radius < 0) balloons.splice(i, 1); }); confetti.forEach((c, i) => { c.update(); c.draw(); if (c.life <= 0) confetti.splice(i, 1); }); balloonLoopId = requestAnimationFrame(startBalloonLoop); }

    // --- BREATHING GAME (FIXED) ---
    let animationId; let particles = []; let baseRadius = 110; let targetRadius = 110; let currentRadius = 110;
    let breathPhase = 'ready'; let breathInterval = null; let breathTimer = 0; let isBreathing = false;
    const INHALE_TIME = 4; const HOLD_TIME = 7; const EXHALE_TIME = 8;
    function resizeBreathCanvas() { breathCanvas.width = window.innerWidth; breathCanvas.height = window.innerHeight; initBreathParticles(); }
    window.addEventListener('resize', resizeBreathCanvas);
    class BreathParticle { constructor() { this.angle = Math.random() * Math.PI * 2; this.distance = baseRadius + Math.random() * 20; this.size = Math.random() * 3 + 1; this.speed = Math.random() * 0.02 + 0.005; this.color = `rgba(100, 181, 246, ${Math.random() * 0.4 + 0.1})`; this.wobble = Math.random() * 20; } update(radius, phase) { this.angle += this.speed; let targetDist = radius + Math.sin(Date.now() / 500 + this.wobble) * 10; if (phase === 'inhale') { targetDist += Math.random() * 10; this.color = `rgba(100, 181, 246, ${Math.random() * 0.6 + 0.3})`; } else if (phase === 'hold') { targetDist += Math.random() * 2; this.color = `rgba(21, 101, 192, ${Math.random() * 0.5 + 0.3})`; } else if (phase === 'exhale') { this.color = `rgba(100, 181, 246, ${Math.random() * 0.3 + 0.1})`; } this.distance += (targetDist - this.distance) * 0.05; const cx = breathCanvas.width / 2; const cy = (breathCanvas.height / 2) - 60; this.x = cx + Math.cos(this.angle) * this.distance; this.y = cy + Math.sin(this.angle) * this.distance; } draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
    function initBreathParticles() { particles = []; for (let i = 0; i < 150; i++) particles.push(new BreathParticle()); }
    function startBreathingAnimationLoop() { if (!animationId) animate(); }
    function stopBreathingAnimationLoop() { cancelAnimationFrame(animationId); animationId = null; }
    function animate() { ctx.clearRect(0, 0, breathCanvas.width, breathCanvas.height); currentRadius += (targetRadius - currentRadius) * 0.02; particles.forEach(p => { p.update(currentRadius, breathPhase); p.draw(); }); animationId = requestAnimationFrame(animate); }
    function toggleBreathing() { if (isBreathing) stopBreathing(); else startBreathing(); }
    function startBreathing() { isBreathing = true; playIcon.innerText = 'pause'; playText.innerText = '–ü–∞—É–∑–∞'; breathInterval = setInterval(() => { breathTimer++; updateGameLogic(); }, 1000); updateGameLogic(); }
    function stopBreathing() { isBreathing = false; clearInterval(breathInterval); breathInterval = null; playIcon.innerText = 'play_arrow'; playText.innerText = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; }
    function resetBreathing() { stopBreathing(); breathTimer = 0; breathPhase = 'ready'; targetRadius = 110; playText.innerText = '–°—Ç–∞—Ä—Ç'; playIcon.innerText = 'play_arrow'; breathLabel.innerText = '–î–´–®–ò–ú'; breathInstruction.innerText = '–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç'; }
    function updateGameLogic() { const cycleTime = breathTimer % (INHALE_TIME + HOLD_TIME + EXHALE_TIME); if (cycleTime < INHALE_TIME) { breathPhase = 'inhale'; targetRadius = 180; breathLabel.innerText = '–í–î–û–•'; breathInstruction.innerText = '–°–ø–æ–∫–æ–π–Ω—ã–π –≤–¥–æ—Ö...'; } else if (cycleTime < INHALE_TIME + HOLD_TIME) { breathPhase = 'hold'; targetRadius = 190; breathLabel.innerText = '–ü–ê–£–ó–ê'; breathInstruction.innerText = '–ó–∞–¥–µ—Ä–∂–∏—Ç–µ...'; } else { breathPhase = 'exhale'; targetRadius = 110; breathLabel.innerText = '–í–´–î–û–•'; breathInstruction.innerText = '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–¥–æ—Ö...'; } }

    // --- OTHER ---
    function playMockAudio(element) { document.querySelectorAll('.play-btn-container').forEach(el => { el.innerHTML = '<span class="material-icons-round">play_arrow</span>'; }); const container = element.querySelector('.play-btn-container'); container.innerHTML = `<div class="equalizer"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div>`; if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }
    function sendVoiceMessage() { /* ... */ } 
    function playAudioResponse(base64) { /* ... */ }
</script>
</body>
</html>
