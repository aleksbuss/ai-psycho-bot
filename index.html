<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–π –ü—Å–∏—Ö–æ–ª–æ–≥</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- –ò–∫–æ–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <style>
    :root {
      /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞: –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –¥–æ–≤–µ—Ä–∏–µ */
      --bg-color: #f5f7fa;
      --chat-bg: #ffffff;
      --primary-color: #5d9cec; /* –ú—è–≥–∫–∏–π —Å–∏–Ω–∏–π */
      --primary-dark: #4a89dc;
      --text-color: #333333;
      --secondary-text: #888888;
      --bot-msg-bg: #f0f2f5;
      --user-msg-bg: #5d9cec;
      --user-msg-text: #ffffff;
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º–Ω—É—é —Ç–µ–º—É –¢–µ–ª–µ–≥—Ä–∞–º–∞ */
    body.dark-mode {
      --bg-color: #1e1e1e;
      --chat-bg: #2c2c2c;
      --text-color: #e0e0e0;
      --bot-msg-bg: #3a3a3a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª—Å—è –≤–µ—Å—å –±–æ–¥–∏ */
    }

    /* --- –®–∞–ø–∫–∞ --- */
    header {
      padding: 15px 20px;
      background: var(--chat-bg);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title h1 { font-size: 18px; font-weight: 600; }
    .header-title p { font-size: 12px; color: var(--secondary-text); margin-top: 2px; }
    .status-dot { height: 8px; width: 8px; background-color: #8cc152; border-radius: 50%; display: inline-block; margin-right: 5px; }

    /* --- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ --- */
    #chat-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto; /* –°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å */
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.3s ease;
      word-wrap: break-word;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ */
    .msg-bot {
      align-self: flex-start;
      background-color: var(--bot-msg-bg);
      border-bottom-left-radius: 4px;
      color: var(--text-color);
    }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .msg-user {
      align-self: flex-end;
      background-color: var(--user-msg-bg);
      color: var(--user-msg-text);
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 5px rgba(93, 156, 236, 0.3);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ */
    .typing-indicator {
      display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      align-self: flex-start;
      background-color: var(--bot-msg-bg);
      padding: 10px 15px;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      margin-bottom: 10px;
    }
    .dot {
      height: 7px; width: 7px; background-color: #bbb; border-radius: 50%; display: inline-block;
      animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    /* --- –ü–æ–ª–µ –≤–≤–æ–¥–∞ --- */
    .input-area {
      background: var(--chat-bg);
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border-radius: 25px;
      border: 1px solid #e0e0e0;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: var(--bg-color);
      color: var(--text-color);
    }

    input[type="text"]:focus { border-color: var(--primary-color); }

    button#sendBtn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s, background-color 0.2s;
      box-shadow: 0 3px 10px rgba(93, 156, 236, 0.3);
    }

    button#sendBtn:active { transform: scale(0.95); }
    button#sendBtn:disabled { background-color: #ccc; box-shadow: none; }

  </style>
</head>
<body>

  <header>
    <div class="header-title">
      <h1>AI –ü—Å–∏—Ö–æ–ª–æ–≥</h1>
      <p><span class="status-dot"></span>–û–Ω–ª–∞–π–Ω</p>
    </div>
  </header>

  <div id="chat-container">
    <div class="message msg-bot">
      –ü—Ä–∏–≤–µ—Ç! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å. –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å? üåø
    </div>
    
    <!-- –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
    <div class="typing-indicator" id="typing">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>

  <div class="input-area">
    <input type="text" id="userInput" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." autocomplete="off">
    <button id="sendBtn">
      <span class="material-icons-round">send</span>
    </button>
  </div>

  <script>
    // ---------------------------------------------------------
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –°–°–´–õ–ö–£, –ö–û–¢–û–†–ê–Ø –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–¢–°–Ø –ù–ê /exec
    // ---------------------------------------------------------
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfZ4OH8TXstzCQe9lZ8zfnqjR6lS6d_KKFRGe0dq36lEN5re84ICuno9Cexn_5cbWS/exec";

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞
    if (tg.colorScheme === 'dark') {
      document.body.classList.add('dark-mode');
    }

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typing');
    
    // –ü–æ–ª—É—á–∞–µ–º ID —é–∑–µ—Ä–∞ (–∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π)
    const userId = tg.initDataUnsafe?.user?.id || 'test_user_' + Math.floor(Math.random() * 1000);

    // --- –§–£–ù–ö–¶–ò–ò ---

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addMessage(text, isUser = false) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      msgDiv.classList.add(isUser ? 'msg-user' : 'msg-bot');
      // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br> –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      msgDiv.innerHTML = text.replace(/\n/g, '<br>');
      chatContainer.insertBefore(msgDiv, typingIndicator);
      scrollToBottom();
    }

    function showTyping(show) {
      typingIndicator.style.display = show ? 'block' : 'none';
      scrollToBottom();
    }

    // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò ---
    function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      addMessage(text, true);
      userInput.value = '';
      sendBtn.disabled = true;
      showTyping(true);

      // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î)
      fetch(GOOGLE_SCRIPT_URL + '?act=api', {
        method: 'POST',
        redirect: "follow", // –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã Google
        headers: {
            "Content-Type": "text/plain;charset=utf-8", // –û–±—Ö–æ–¥ CORS
        },
        body: JSON.stringify({ text: text, userId: userId })
      })
      .then(response => response.json())
      .then(data => {
        showTyping(false);
        sendBtn.disabled = false;
        userInput.focus();
        
        if (data.status === 'success') {
          addMessage(data.text, false);
          // –í–∏–±—Ä–∞—Ü–∏—è (Haptic Feedback)
          if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        } else {
          addMessage("‚ö†Ô∏è " + data.text, false);
        }
      })
      .catch(error => {
        showTyping(false);
        sendBtn.disabled = false;
        console.error('Error:', error);
        addMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É —Å–∫—Ä–∏–ø—Ç–∞.", false);
      });
    }

    // --- –°–û–ë–´–¢–ò–Ø ---
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    window.visualViewport.addEventListener('resize', scrollToBottom);

  </script>
</body>
</html>
